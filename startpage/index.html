<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your new day starts here.">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Startpage">
    <meta property="og:description" content="Your new day starts here.">
    <meta property="og:url" content="https://vietanhbui2000.github.io/web-apps/startpage/">
    <meta property="og:image"
        content="https://vietanhbui2000.github.io/web-apps/startpage/startpage_thumbnail_1200x630.png">

    <title>Startpage</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="startpage_icon_any_x192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f5f5f5" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#09090b" media="(prefers-color-scheme: dark)">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: {
                            light: '#f5f5f5',
                            dark: '#09090b',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Smooth fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }

        /* Modal transitions */
        .modal-enter {
            opacity: 0;
            pointer-events: none;
        }

        .modal-enter .modal-content {
            transform: translateY(100%);
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @media (min-width: 640px) {
            .modal-enter .modal-content {
                transform: translateY(20px);
            }
        }

        .modal-active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-active .modal-content {
            transform: translateY(0);
        }

        /* Scrollbar for settings */
        .custom-scrollbar {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE 10+ */
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        /* Dragging visual cue */
        .dragging {
            opacity: 0.5;
            background-color: rgba(113, 113, 122, 0.1);
            border: 2px dashed rgba(113, 113, 122, 0.3);
        }

        /* Blinking animation */
        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .blinking {
            animation: blink 1s step-end infinite;
        }

        /* Shake animation */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .animate-shake {
            animation: shake 0.2s ease-in-out 2;
        }
    </style>
</head>

<body
    class="min-h-screen bg-background-light dark:bg-background-dark text-zinc-800 dark:text-zinc-300 selection:bg-zinc-200 dark:selection:bg-zinc-800 flex items-center justify-center p-6 relative overflow-hidden transition-colors duration-300">

    <div class="w-full max-w-3xl space-y-12 mb-32">

        <!-- Header Section -->
        <header class="space-y-2 animate-fade-in flex flex-col items-center" style="animation-delay: 100ms;">
            <div class="flex items-center gap-3 text-zinc-500 font-medium text-sm tracking-wide uppercase">
                <p id="date-display">Loading date...</p>
                <span class="w-1 h-1 rounded-full bg-zinc-300 dark:bg-zinc-700"></span>
                <p id="time-display">00:00</p>
            </div>
            <h1
                class="text-4xl md:text-5xl font-bold text-zinc-900 dark:text-white tracking-tight transition-colors text-center">
                <span id="greeting-display">Hello</span><span id="username-container" class="hidden">, <span
                        id="username-display">User</span></span>
            </h1>
        </header>

        <!-- Main Area -->
        <form id="main-form" class="w-full z-20 flex gap-3 relative">

            <!-- Main Input Field -->
            <div
                class="relative flex-1 group flex items-center w-full h-16 bg-white/60 dark:bg-zinc-900/60 backdrop-blur-2xl border border-zinc-200/50 dark:border-zinc-800/50 rounded-2xl focus-within:border-zinc-300/80 dark:focus-within:border-zinc-600/80 transition-all duration-300 ease-out shadow-md dark:shadow-lg focus-within:shadow-xl dark:focus-within:shadow-2xl">
                <input id="main-input" type="text" placeholder="Search / Ask anything..." autocomplete="off"
                    autocapitalize="off" autocorrect="off" spellcheck="false"
                    class="flex-1 w-0 bg-transparent border-none text-zinc-900 dark:text-white text-lg px-5 h-full focus:outline-none focus:ring-0 placeholder:text-zinc-400 dark:placeholder:text-zinc-600" />

                <!-- Right Side Action -->
                <div id="action-btn"
                    class="group/action shrink-0 pr-5 flex items-center h-full cursor-pointer transition-all">
                    <!-- Action Space -->
                    <kbd id="action-space"
                        class="hidden sm:inline-flex items-center gap-1 px-2.5 py-1 text-xs font-mono text-zinc-500 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-500/10 rounded border border-zinc-200 dark:border-zinc-500/20 transition-all [@media(hover:hover)]:group-hover/action:border-zinc-300 [@media(hover:hover)]:dark:group-hover/action:border-zinc-500/50 [@media(hover:hover)]:group-hover/action:shadow-[0_0_15px_rgba(0,0,0,0.1)] [@media(hover:hover)]:dark:group-hover/action:shadow-[0_0_15px_rgba(0,0,0,0.5)]">
                        Space
                    </kbd>
                    <!-- Action Enter -->
                    <span id="action-enter"
                        class="hidden items-center gap-1 px-2.5 py-1 text-xs font-medium rounded border transition-all">
                        <!-- Content injected via JS -->
                    </span>
                </div>
            </div>
        </form>

        <!-- Links Grid -->
        <div class="animate-fade-in" id="links-container" style="animation-delay: 300ms;">
            <!-- Links will be injected here by JavaScript -->
        </div>

    </div>

    <!-- Help Button -->
    <div class="fixed bottom-6 left-6 z-30">
        <button id="help-toggle"
            class="p-2 rounded-lg text-zinc-400 [@media(hover:hover)]:hover:bg-zinc-200 [@media(hover:hover)]:dark:hover:bg-zinc-800 [@media(hover:hover)]:hover:text-zinc-800 [@media(hover:hover)]:dark:hover:text-zinc-300 transition-all"
            aria-label="Help">
            <i data-lucide="help-circle" class="w-4 h-4"></i>
        </button>
    </div>

    <!-- Theme & Settings Buttons -->
    <div class="fixed bottom-6 right-6 z-30 flex gap-2">
        <button id="theme-toggle"
            class="p-2 rounded-lg text-zinc-400 [@media(hover:hover)]:hover:bg-zinc-200 [@media(hover:hover)]:dark:hover:bg-zinc-800 [@media(hover:hover)]:hover:text-zinc-800 [@media(hover:hover)]:dark:hover:text-zinc-300 transition-all"
            aria-label="Toggle Theme">
            <!-- Icon injected via JS -->
        </button>
        <button id="settings-toggle"
            class="p-2 rounded-lg text-zinc-400 [@media(hover:hover)]:hover:bg-zinc-200 [@media(hover:hover)]:dark:hover:bg-zinc-800 [@media(hover:hover)]:hover:text-zinc-800 [@media(hover:hover)]:dark:hover:text-zinc-300 transition-all"
            aria-label="Settings">
            <i data-lucide="settings" class="w-4 h-4"></i>
        </button>
    </div>

    <!-- Help Modal -->
    <div id="help-modal"
        class="hidden fixed inset-0 bg-black/20 dark:bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center modal-enter transition-opacity duration-200">
        <div
            class="modal-content bg-white dark:bg-zinc-900 w-full h-full sm:h-auto sm:max-w-lg p-4 sm:p-6 rounded-none sm:rounded-2xl border-none sm:border border-zinc-200 dark:border-zinc-800 shadow-none sm:shadow-2xl transition-transform duration-200 ring-0 sm:ring-1 ring-zinc-900/5 dark:ring-white/10 flex flex-col sm:max-h-[85vh]">

            <div class="flex justify-between items-center mb-6 shrink-0">
                <h2 class="text-xl font-bold text-zinc-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="help-circle" class="w-5 h-5 text-zinc-500 dark:text-zinc-400"></i> Usage Guide
                </h2>
                <button id="close-help"
                    class="text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-6 overflow-y-auto custom-scrollbar px-2 pb-4">

                <!-- Search & Ask -->
                <div class="space-y-3">
                    <h3
                        class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="search" class="w-4 h-4"></i> Search & Ask
                    </h3>
                    <div
                        class="bg-zinc-50 dark:bg-zinc-800/50 rounded-lg p-4 border border-zinc-100 dark:border-zinc-800 space-y-3">
                        <div class="flex items-start gap-3">
                            <span
                                class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">query
                                .</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                <strong class="text-zinc-900 dark:text-zinc-200">Search:</strong> Type anything to
                                search.
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span
                                class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">query
                                ?</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                <strong class="text-zinc-900 dark:text-zinc-200">Ask:</strong> Begin/end with a
                                <code class="bg-zinc-200 dark:bg-zinc-700 px-1 rounded">?</code> to "ask" the AI.
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span
                                class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">g
                                query</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                <strong class="text-zinc-900 dark:text-zinc-200">Switch Engines:</strong> Type a
                                trigger (e.g. <code class="bg-zinc-200 dark:bg-zinc-700 px-1 rounded">g</code>)
                                followed by Space/Tab to switch engines.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Speed Dial -->
                <div class="space-y-3">
                    <h3
                        class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="zap" class="w-4 h-4"></i> Speed Dial
                    </h3>
                    <div
                        class="bg-zinc-50 dark:bg-zinc-800/50 rounded-lg p-4 border border-zinc-100 dark:border-zinc-800 space-y-3">
                        <div class="flex items-start gap-3">
                            <span
                                class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">0-9</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                <strong class="text-zinc-900 dark:text-zinc-200">Hotkeys:</strong> Press Alt/Option +
                                Number Keys (1-9, and 0 for the 10th item) to instantly open links.
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span
                                class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">yt~</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                <strong class="text-zinc-900 dark:text-zinc-200">Text Triggers:</strong> Type a
                                trigger
                                (e.g. <code class="bg-zinc-200 dark:bg-zinc-700 px-1 rounded">yt</code>) and hit Enter
                                to go to a site or open a page.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="space-y-3">
                    <h3
                        class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="keyboard" class="w-4 h-4"></i> Navigation
                    </h3>
                    <div
                        class="bg-zinc-50 dark:bg-zinc-800/50 rounded-lg p-4 border border-zinc-100 dark:border-zinc-800">
                        <div class="flex items-start gap-3">
                            <span
                                class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">Space</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                Press Space to focus the input field from anywhere.
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="hidden fixed inset-0 bg-black/20 dark:bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center modal-enter transition-opacity duration-200">
        <div
            class="modal-content bg-white dark:bg-zinc-900 w-full h-full sm:h-auto sm:max-w-lg p-4 sm:p-6 rounded-none sm:rounded-2xl border-none sm:border border-zinc-200 dark:border-zinc-800 shadow-none sm:shadow-2xl transition-transform duration-200 ring-0 sm:ring-1 ring-zinc-900/5 dark:ring-white/10 flex flex-col sm:max-h-[85vh]">

            <div class="flex justify-between items-center mb-6 shrink-0">
                <h2 class="text-xl font-bold text-zinc-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-zinc-500 dark:text-zinc-400"></i> Settings
                </h2>
                <button id="close-settings"
                    class="text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-8 overflow-y-auto custom-scrollbar px-2">

                <!-- General Settings -->
                <div class="space-y-4">
                    <h3
                        class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i> General
                    </h3>

                    <div class="space-y-2">
                        <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Name</label>
                        <input type="text" id="setting-username" placeholder="Enter your name"
                            class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-4 py-2 text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="setting-enable-greetings"
                                class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Enable Greetings</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="setting-autofocus-input"
                                class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Auto-focus Input
                                Field</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="setting-open-query-new-tab"
                                class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Open Queries in New
                                Tab</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="setting-open-link-new-tab"
                                class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Open Links in New
                                Tab</span>
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Date Format</label>
                            <select id="setting-date-format"
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm font-medium text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all appearance-none cursor-pointer mb-2">
                                <option value="short">Short (Nov 9)</option>
                                <option value="long">Long (November 9)</option>
                                <option value="numeric">Numeric (9/11)</option>
                            </select>
                            <label class="flex items-center gap-2 cursor-pointer mb-1">
                                <input type="checkbox" id="setting-show-weekday"
                                    class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                                <span class="text-xs text-zinc-500 dark:text-zinc-400">Show day of week</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="setting-show-year"
                                    class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                                <span class="text-xs text-zinc-500 dark:text-zinc-400">Show year</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="setting-show-leading-zero"
                                    class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                                <span class="text-xs text-zinc-500 dark:text-zinc-400">Show leading zero</span>
                            </label>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Time Format</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <button
                                    class="format-btn p-2 rounded-lg border border-zinc-200 dark:border-zinc-800 text-sm font-medium transition-all hover:bg-zinc-100 dark:hover:bg-zinc-800"
                                    data-type="time" data-value="12">12-hour</button>
                                <button
                                    class="format-btn p-2 rounded-lg border border-zinc-200 dark:border-zinc-800 text-sm font-medium transition-all hover:bg-zinc-100 dark:hover:bg-zinc-800"
                                    data-type="time" data-value="24">24-hour</button>
                            </div>
                            <label class="flex items-center gap-2 cursor-pointer mb-1">
                                <input type="checkbox" id="setting-show-ampm"
                                    class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="text-xs text-zinc-500 dark:text-zinc-400">Show AM/PM</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="setting-show-seconds"
                                    class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                                <span class="text-xs text-zinc-500 dark:text-zinc-400">Show seconds</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="setting-flash-separators"
                                    class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                                <span class="text-xs text-zinc-500 dark:text-zinc-400">Flash the separators</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Search & Ask Settings -->
                <div class="space-y-4" id="setting-engines-section">
                    <h3
                        class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="search" class="w-4 h-4"></i> Search & Ask
                    </h3>

                    <p class="text-xs text-zinc-500 dark:text-zinc-400">
                        The engines you choose here will be used for features like searching and asking from the input
                        field.
                    </p>

                    <p class="text-xs text-zinc-500 dark:text-zinc-400">
                        By default, queries will be searched and routed to the Search Engine <i data-lucide="search"
                            class="inline w-3 h-3"></i>. Queries ending with <code
                            class="bg-zinc-200 dark:bg-zinc-700 px-1 rounded">?</code> will be "asked" and routed to
                        the Ask
                        Engine <i data-lucide="search-slash" class="inline w-3 h-3"></i>.
                    </p>

                    <p class="text-xs text-zinc-500 dark:text-zinc-400">
                        You can use text triggers (Shortcut/Name/URL) in the input field to use a different engine or to
                        quickly search a
                        specific site.
                    </p>

                    <!-- Add/Edit Engine Form -->
                    <div id="setting-engine-form"
                        class="p-4 rounded-xl bg-zinc-50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-800 space-y-3">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <input type="text" id="new-engine-name" placeholder="Name (e.g. Google)"
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                            <input type="text" id="new-engine-shortcut" placeholder="Shortcut (e.g. g)"
                                autocapitalize="off" autocorrect="off"
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                        </div>
                        <input type="url" id="new-engine-url" placeholder="Query URL (e.g. google.com/search?q=%s)"
                            class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">

                        <div class="flex gap-2">
                            <button id="save-engine-btn"
                                class="flex-1 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                                Add Engine
                            </button>
                            <button id="cancel-engine-edit"
                                class="hidden px-4 bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-300 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                                Cancel
                            </button>
                        </div>
                        <!-- Error message for Engine Form -->
                        <p id="setting-engine-form-error" class="text-red-500 text-xs hidden pt-1"></p>
                    </div>

                    <!-- Engine List -->
                    <div id="setting-engines-list" class="space-y-2">
                        <!-- Engines injected via JS -->
                    </div>

                    <!-- Trigger Settings -->
                    <div class="space-y-4 pt-2 border-t border-zinc-100 dark:border-zinc-800">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Trigger Key</label>
                            <select id="setting-engine-trigger-key"
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm font-medium text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all appearance-none cursor-pointer">
                                <option value="both">Space or Tab</option>
                                <option value="space">Space</option>
                                <option value="tab">Tab</option>
                            </select>
                            <p class="text-[10px] text-zinc-400 dark:text-zinc-500">
                                Choose which key triggers an action.
                            </p>
                        </div>

                        <div class="space-y-2">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Input Match Mode</label>
                            <select id="setting-engine-match-mode"
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm font-medium text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all appearance-none cursor-pointer">
                                <option value="shortcut">Shortcut only</option>
                                <option value="shortcut_name">Shortcut / Name</option>
                                <option value="shortcut_name_url">Shortcut / Name / URL</option>
                            </select>
                            <p class="text-[10px] text-zinc-400 dark:text-zinc-500">
                                Choose which text input triggers an engine (e.g. by shortcut <code
                                    class="bg-zinc-200 dark:bg-zinc-700 px-1 rounded">g</code>, name <code
                                    class="bg-zinc-200 dark:bg-zinc-700 px-1 rounded">google</code>, or
                                URL).
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Speed Dial Settings -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3
                            class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider flex items-center gap-2">
                            <i data-lucide="zap" class="w-4 h-4"></i> Speed Dial <span id="link-count"
                                class="ml-1 text-xs text-zinc-500 font-normal"></span>
                        </h3>
                    </div>

                    <p class="text-xs text-zinc-500 dark:text-zinc-400">
                        Quickly go to a site or open a page using hotkey and/or trigger (Shortcut/Name/URL).
                    </p>

                    <!-- Show/Hide Toggle -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="setting-show-speed-dial"
                                class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Show on Startpage</span>
                        </label>
                    </div>

                    <!-- Add/Edit Link Form -->
                    <div id="setting-link-form"
                        class="p-4 rounded-xl bg-zinc-50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-800 space-y-3">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <input type="text" id="new-link-name" placeholder="Name (e.g. YouTube)"
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                            <input type="text" id="new-link-shortcut" placeholder="Shortcut (e.g. yt)"
                                autocapitalize="off" autocorrect="off"
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                        </div>
                        <input type="url" id="new-link-url" placeholder="URL (e.g. youtube.com)"
                            class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                        <div class="flex gap-2">
                            <button id="save-link-btn"
                                class="flex-1 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                                Add Link
                            </button>
                            <button id="cancel-link-edit"
                                class="hidden px-4 bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-300 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                                Cancel
                            </button>
                        </div>
                        <!-- Error message for Link Form -->
                        <p id="setting-link-form-error" class="text-red-500 text-xs hidden pt-1"></p>
                    </div>

                    <!-- List of links -->
                    <div id="setting-links-list" class="space-y-2">
                        <!-- Items injected via JS -->
                    </div>

                    <!-- Layout Selector & Advanced Settings -->
                    <div class="space-y-4 pt-2 border-t border-zinc-100 dark:border-zinc-800">

                        <!-- Section 1: Layout View -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Layout View</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button
                                    class="setting-link-layout-view p-2 rounded-lg border border-zinc-200 dark:border-zinc-800 flex items-center justify-center gap-2 text-sm font-medium hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all"
                                    data-value="list">
                                    <i data-lucide="layout-list" class="w-4 h-4"></i>
                                    <span>List</span>
                                </button>
                                <button
                                    class="setting-link-layout-view p-2 rounded-lg border border-zinc-200 dark:border-zinc-800 flex items-center justify-center gap-2 text-sm font-medium hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all"
                                    data-value="grid">
                                    <i data-lucide="layout-grid" class="w-4 h-4"></i>
                                    <span>Grid</span>
                                </button>
                            </div>
                        </div>

                        <!-- Section 2: Input Match Mode -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Input Match Mode</label>
                            <select id="setting-link-match-mode"
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm font-medium text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all appearance-none cursor-pointer">
                                <option value="shortcut">Shortcut only</option>
                                <option value="shortcut_name">Shortcut / Name</option>
                                <option value="shortcut_name_url">Shortcut / Name / URL</option>
                            </select>
                            <p class="text-[10px] text-zinc-400 dark:text-zinc-500">
                                Choose which text input triggers a link (e.g. by shortcut <code
                                    class="bg-zinc-200 dark:bg-zinc-700 px-1 rounded">yt</code>, name <code
                                    class="bg-zinc-200 dark:bg-zinc-700 px-1 rounded">youtube</code>, or URL).
                            </p>
                        </div>

                        <!-- Section 3: Hotkey Mode & Auto-open Links -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Hotkey Mode</label>
                                <select id="setting-link-hotkey-mode"
                                    class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm font-medium text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all appearance-none cursor-pointer">
                                    <option value="alt">Alt/Option + 0-9</option>
                                    <option value="numeric">Number Keys only (0-9)</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                                <p class="text-[10px] text-zinc-400 dark:text-zinc-500">
                                    Hotkeys will always open links instantly.
                                </p>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Auto-open
                                    Links</label>
                                <select id="setting-link-auto-open"
                                    class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm font-medium text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all appearance-none cursor-pointer">
                                    <option value="disabled">Disabled (Wait for Enter)</option>
                                    <option value="immediate">Immediately</option>
                                    <option value="delay_1s">After 1 second</option>
                                    <option value="delay_2s">After 2 seconds</option>
                                </select>
                                <p class="text-[10px] text-zinc-400 dark:text-zinc-500">
                                    Only applies to text input triggers.
                                </p>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <!-- Footer with Reset, Import, Export, Save -->
            <div
                class="mt-6 pt-4 border-t border-zinc-100 dark:border-zinc-800 flex justify-between items-center shrink-0">
                <div class="flex gap-2">
                    <button id="reset-settings-btn"
                        class="p-2 rounded-md text-zinc-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                        title="Reset to Defaults">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    </button>
                    <div class="h-8 w-px bg-zinc-100 dark:bg-zinc-800 mx-1"></div>
                    <button id="import-settings-btn"
                        class="p-2 rounded-lg text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all"
                        title="Import Settings (JSON)">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                    </button>
                    <button id="export-settings-btn"
                        class="p-2 rounded-lg text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all"
                        title="Export Settings (JSON)">
                        <i data-lucide="download" class="w-4 h-4"></i>
                    </button>
                </div>
                <button id="save-settings"
                    class="px-6 py-2 rounded-lg font-medium text-sm transition-all duration-200 bg-zinc-200 dark:bg-zinc-700 text-zinc-400 dark:text-zinc-500">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden File Input for Import -->
    <input type="file" id="import-file-input" accept=".json" class="hidden" />

    <script>
        // --- Configuration & State ---
        const DISPLAY_LIMIT = 10; // Show first 10 on main screen

        const defaultEngines = [
            { name: 'Google', shortcut: 'g', url: 'https://www.google.com/search?q=%s' },
            { name: 'DuckDuckGo', shortcut: 'ddg', url: 'https://duckduckgo.com/?q=%s' },
            { name: 'Bing', shortcut: 'b', url: 'https://www.bing.com/search?q=%s' },
            { name: 'ChatGPT', shortcut: 'ai', url: 'https://chatgpt.com/?q=%s' },
        ];

        let preferences = {
            // General
            theme: localStorage.getItem('theme') || 'auto',
            username: localStorage.getItem('username') || '',
            enableGreetings: localStorage.getItem('enableGreetings') === 'true',
            autofocusInput: localStorage.getItem('autofocusInput') === 'true',
            openQueryNewTab: localStorage.getItem('openQueryNewTab') === 'true',
            openLinkNewTab: localStorage.getItem('openLinkNewTab') === 'true',
            // Date
            dateFormat: localStorage.getItem('dateFormat') || 'short',
            showWeekday: localStorage.getItem('showWeekday') !== 'false',
            showYear: localStorage.getItem('showYear') === 'true',
            showLeadingZero: localStorage.getItem('showLeadingZero') === 'true',
            // Time
            timeFormat: localStorage.getItem('timeFormat') || '12',
            showAmPm: localStorage.getItem('showAmPm') !== 'false',
            showSeconds: localStorage.getItem('showSeconds') === 'true',
            flashSeparators: localStorage.getItem('flashSeparators') === 'true',
            // Engines
            engines: safeJsonParse(localStorage.getItem('engines'), defaultEngines),
            engineDefaultSearch: localStorage.getItem('engineDefaultSearch') || 'Google',
            engineDefaultAsk: localStorage.getItem('engineDefaultAsk') || 'Google',
            engineTriggerKey: localStorage.getItem('engineTriggerKey') || 'both',
            engineMatchMode: localStorage.getItem('engineMatchMode') || 'shortcut',
            // Speed Dial
            showSpeedDial: localStorage.getItem('showSpeedDial') !== 'false',
            links: safeJsonParse(localStorage.getItem('links'), []),
            linkLayout: localStorage.getItem('linkLayout') || 'list',
            linkMatchMode: localStorage.getItem('linkMatchMode') || 'shortcut',
            linkHotkeyMode: localStorage.getItem('linkHotkeyMode') || 'alt',
            linkAutoOpen: localStorage.getItem('linkAutoOpen') || 'disabled',
        };

        // Runtime State
        let draggedItem = null;
        let lastMouseDownTarget = null;
        let editingEngineIndex = null;
        let editingLinkIndex = null;
        let resetConfirmTimeout = null;
        let autoOpenTimeout = null;
        let closeWarningActive = false;
        let closeWarningTimeout = null;

        // Settings Temporary State (for Dirty Checking)
        let tempPreferences = null;
        let originalPreferencesSnapshot = null;

        // This tracks the engine that was explicitly triggered by a valid keystroke sequence
        let activeActionEngine = null;

        // Header Elements
        const dateDisplay = document.getElementById('date-display');
        const timeDisplay = document.getElementById('time-display');
        const greetingDisplay = document.getElementById('greeting-display');
        const usernameContainer = document.getElementById('username-container');
        const usernameDisplay = document.getElementById('username-display');

        // Main Elements
        const mainForm = document.getElementById('main-form');
        const mainInput = document.getElementById('main-input');
        const actionBtn = document.getElementById('action-btn');
        const actionSpace = document.getElementById('action-space');
        const actionEnter = document.getElementById('action-enter');
        const linksContainer = document.getElementById('links-container');

        // Help Modal Elements
        const helpToggle = document.getElementById('help-toggle');
        const helpModal = document.getElementById('help-modal');
        const closeHelpBtn = document.getElementById('close-help');

        // Theme Modal Elements
        const themeToggle = document.getElementById('theme-toggle');

        // Settings Modal Elements
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings');
        const saveSettingsBtn = document.getElementById('save-settings');

        // Data Management Elements
        const resetSettingsBtn = document.getElementById('reset-settings-btn');
        const importSettingsBtn = document.getElementById('import-settings-btn');
        const exportSettingsBtn = document.getElementById('export-settings-btn');
        const importFileInput = document.getElementById('import-file-input');

        // Settings - General
        const settingUsername = document.getElementById('setting-username');
        const settingEnableGreetings = document.getElementById('setting-enable-greetings');
        const settingAutofocusInput = document.getElementById('setting-autofocus-input');
        const settingOpenQueryNewTab = document.getElementById('setting-open-query-new-tab');
        const settingOpenLinkNewTab = document.getElementById('setting-open-link-new-tab');
        const settingDateFormat = document.getElementById('setting-date-format');
        const settingShowWeekday = document.getElementById('setting-show-weekday');
        const settingShowYear = document.getElementById('setting-show-year');
        const settingShowLeadingZero = document.getElementById('setting-show-leading-zero');
        const settingTimeFormat = document.querySelectorAll('.format-btn[data-type=\"time\"]');
        const settingShowAmPm = document.getElementById('setting-show-ampm');
        const settingShowSeconds = document.getElementById('setting-show-seconds');
        const settingFlashSeparators = document.getElementById('setting-flash-separators');

        // Settings - Search & Ask
        const settingEngineForm = document.getElementById('setting-engine-form');
        const settingEngineFormError = document.getElementById('setting-engine-form-error');
        const newEngineName = document.getElementById('new-engine-name');
        const newEngineShortcut = document.getElementById('new-engine-shortcut');
        const newEngineUrl = document.getElementById('new-engine-url');
        const saveEngineBtn = document.getElementById('save-engine-btn');
        const cancelEngineEditBtn = document.getElementById('cancel-engine-edit');
        const settingEnginesList = document.getElementById('setting-engines-list');
        const settingEngineTriggerKey = document.getElementById('setting-engine-trigger-key');
        const settingEngineMatchMode = document.getElementById('setting-engine-match-mode');

        // Settings - Speed Dial
        const linkCount = document.getElementById('link-count');
        const settingShowSpeedDial = document.getElementById('setting-show-speed-dial');
        const settingLinkForm = document.getElementById('setting-link-form');
        const settingLinkFormError = document.getElementById('setting-link-form-error');
        const newLinkName = document.getElementById('new-link-name');
        const newLinkShortcut = document.getElementById('new-link-shortcut');
        const newLinkUrl = document.getElementById('new-link-url');
        const saveLinkBtn = document.getElementById('save-link-btn');
        const cancelLinkEditBtn = document.getElementById('cancel-link-edit');
        const settingLinksList = document.getElementById('setting-links-list');
        const settingLinkLayoutView = document.querySelectorAll('.setting-link-layout-view');
        const settingLinkMatchMode = document.getElementById('setting-link-match-mode');
        const settingLinkHotkeyMode = document.getElementById('setting-link-hotkey-mode');
        const settingLinkAutoOpen = document.getElementById('setting-link-auto-open');

        // --- Helper Functions ---

        function getFavicon(url) {
            try {
                const cleanUrl = url.replaceAll('%s', '');
                const domain = new URL(cleanUrl).hostname;
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
            } catch (e) {
                return 'https://www.google.com/s2/favicons?domain=google.com&sz=128';
            }
        }

        function formatUrl(url) {
            if (!url) return '';
            let formatted = url.trim();
            if (!/^https?:\/\//i.test(formatted)) {
                formatted = 'https://' + formatted;
            }
            try {
                new URL(formatted);
                return formatted;
            } catch (e) {
                return formatted;
            }
        }

        function getModifierKeyName() {
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0 || navigator.userAgent.toUpperCase().indexOf('MAC') >= 0;
            return isMac ? 'Option' : 'Alt';
        }

        function safeJsonParse(jsonString, fallback) {
            if (!jsonString) return fallback;
            try {
                return JSON.parse(jsonString);
            } catch (e) {
                console.warn('Failed to parse JSON from localStorage:', e);
                return fallback;
            }
        }

        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(element) {
            element.classList.add('hidden');
        }

        function clearAndResetInput() {
            mainInput.value = '';
            mainInput.blur();
            mainInput.dispatchEvent(new Event('input'));
        }

        /**
         * Finds the best matching engine for the input string based on priority:
         */
        function findMatchingEngine(input) {
            if (!input || !input.trim()) return null;
            const mode = preferences.engineMatchMode; // shortcut, shortcut_name, shortcut_name_url
            const lowerInput = input.toLowerCase();

            // 1. Exact Shortcut (Highest Priority - Check ALL engines first)
            for (const engine of preferences.engines) {
                if (engine.shortcut.toLowerCase() === lowerInput) return engine;
            }

            // 2. Exact Name (Medium Priority)
            if (mode !== 'shortcut') {
                for (const engine of preferences.engines) {
                    if (engine.name.toLowerCase() === lowerInput) return engine;
                }
            }

            // 3. URL (Low Priority - Strict Domain Match)
            if (mode === 'shortcut_name_url') {
                for (const engine of preferences.engines) {
                    const cleanUrl = engine.url.replace(/^(https?:\/\/)?(www\.)?/, '').toLowerCase();
                    if (cleanUrl.startsWith(lowerInput)) return engine;
                }
            }

            return null;
        }

        /**
         * Finds the best matching link for the input string based on priority.
         */
        function findMatchingLink(input) {
            if (!input || !input.trim()) return null;
            const mode = preferences.linkMatchMode; // shortcut, shortcut_name, shortcut_name_url
            const lowerInput = input.toLowerCase();

            // 1. Exact Shortcut
            for (const link of preferences.links) {
                if (link.shortcut.toLowerCase() === lowerInput) return link;
            }

            // 2. Exact Name
            if (mode !== 'shortcut') {
                for (const link of preferences.links) {
                    if (link.name.toLowerCase() === lowerInput) return link;
                }
            }

            // 3. URL (Low Priority - Strict Domain Match)
            if (mode === 'shortcut_name_url') {
                for (const link of preferences.links) {
                    const cleanUrl = link.url.replace(/^(https?:\/\/)?(www\.)?/, '').toLowerCase();
                    if (cleanUrl.startsWith(lowerInput)) return link;
                }
            }

            return null;
        }

        /**
         * Converts a numeric key (0-9) to a speed dial link index.
         * Keys 1-9 map to indices 0-8, key 0 maps to index 9.
         * Returns -1 if the key is not a valid number or out of range.
         */
        function getLinkIndexFromNumericKey(key) {
            const num = parseInt(key);
            if (isNaN(num) || num < 0 || num > 9) return -1;
            return num === 0 ? 9 : num - 1;
        }

        function persistPreferences() {
            localStorage.setItem('username', preferences.username);
            localStorage.setItem('enableGreetings', preferences.enableGreetings);
            localStorage.setItem('autofocusInput', preferences.autofocusInput);
            localStorage.setItem('openQueryNewTab', preferences.openQueryNewTab);
            localStorage.setItem('openLinkNewTab', preferences.openLinkNewTab);
            localStorage.setItem('dateFormat', preferences.dateFormat);
            localStorage.setItem('showWeekday', preferences.showWeekday);
            localStorage.setItem('showYear', preferences.showYear);
            localStorage.setItem('showLeadingZero', preferences.showLeadingZero);
            localStorage.setItem('timeFormat', preferences.timeFormat);
            localStorage.setItem('showAmPm', preferences.showAmPm);
            localStorage.setItem('showSeconds', preferences.showSeconds);
            localStorage.setItem('flashSeparators', preferences.flashSeparators);
            localStorage.setItem('engines', JSON.stringify(preferences.engines));
            localStorage.setItem('engineDefaultSearch', preferences.engineDefaultSearch);
            localStorage.setItem('engineDefaultAsk', preferences.engineDefaultAsk);
            localStorage.setItem('engineTriggerKey', preferences.engineTriggerKey);
            localStorage.setItem('engineMatchMode', preferences.engineMatchMode);
            localStorage.setItem('showSpeedDial', preferences.showSpeedDial);
            localStorage.setItem('links', JSON.stringify(preferences.links));
            localStorage.setItem('linkLayout', preferences.linkLayout);
            localStorage.setItem('linkMatchMode', preferences.linkMatchMode);
            localStorage.setItem('linkHotkeyMode', preferences.linkHotkeyMode);
            localStorage.setItem('linkAutoOpen', preferences.linkAutoOpen);
        }

        // --- Core Functions ---

        function updateDateTime() {
            const now = new Date();

            // Date Format
            const d = now;
            const year = d.getFullYear();
            const day = d.getDate();
            const monthIndex = d.getMonth();

            const formatNum = (num) => {
                if (preferences.showLeadingZero) {
                    return num.toString().padStart(2, '0');
                }
                return num.toString();
            };

            let dateText = '';
            let weekdayFormat = 'long';

            switch (preferences.dateFormat) {
                case 'short':
                default:
                    const shortMonth = d.toLocaleDateString('en-US', { month: 'short' });
                    dateText = `${shortMonth} ${formatNum(day)}`;
                    if (preferences.showYear) dateText += ` ${year}`;
                    weekdayFormat = 'short';
                    break;

                case 'long':
                    const longMonth = d.toLocaleDateString('en-US', { month: 'long' });
                    dateText = `${longMonth} ${formatNum(day)}`;
                    if (preferences.showYear) dateText += `, ${year}`;
                    break;

                case 'numeric':
                    dateText = `${formatNum(day)}/${formatNum(monthIndex + 1)}`;
                    if (preferences.showYear) dateText += `/${year}`;
                    break;
            }

            if (preferences.showWeekday) {
                const weekday = d.toLocaleDateString('en-US', { weekday: weekdayFormat });
                dateText = `${weekday}, ${dateText}`;
            }

            dateDisplay.textContent = dateText;

            // Time Format
            const h = now.getHours();
            const m = now.getMinutes();
            const s = now.getSeconds();
            const is12 = preferences.timeFormat === '12';

            let hours = h;
            let ampm = '';
            if (is12) {
                hours = h % 12 || 12;
                ampm = h >= 12 ? ' PM' : ' AM';
            }

            const pad = (n) => n.toString().padStart(2, '0');
            const sepClass = preferences.flashSeparators ? 'blinking' : '';
            const sep = `<span class="${sepClass}">:</span>`;

            let timeHtml = `${hours}${sep}${pad(m)}`;
            if (preferences.showSeconds) {
                timeHtml += `${sep}${pad(s)}`;
            }
            if (ampm && preferences.showAmPm && is12) timeHtml += `<span class="text-sm ml-1">${ampm}</span>`;

            timeDisplay.innerHTML = timeHtml;

            updateGreetingUI();
        }

        function updateGreetingUI() {
            if (!preferences.enableGreetings) {
                greetingDisplay.textContent = 'Startpage';
                usernameContainer.classList.add('hidden');
                return;
            }

            const now = new Date();
            const hour = now.getHours();
            let greeting = 'Good evening';
            if (hour < 12) greeting = 'Good morning';
            else if (hour < 18) greeting = 'Good afternoon';

            greetingDisplay.textContent = greeting;

            if (preferences.username && preferences.username.trim() !== '') {
                usernameContainer.classList.remove('hidden');
                usernameDisplay.textContent = preferences.username;
            } else {
                usernameContainer.classList.add('hidden');
            }
        }

        // --- Speed Dial/Links Rendering ---

        function renderLinks() {
            if (!preferences.showSpeedDial) {
                linksContainer.innerHTML = '';
                linksContainer.className = "hidden";
                return;
            }

            const linksToShow = preferences.links.slice(0, DISPLAY_LIMIT);
            const isIconMode = preferences.linkLayout === 'grid';
            const linkHotkeyMode = preferences.linkHotkeyMode;
            const showHotkeys = linkHotkeyMode !== 'disabled';

            if (linksToShow.length === 0) {
                linksContainer.innerHTML = '';
                linksContainer.className = "animate-fade-in";
                return;
            }


            if (isIconMode) {
                linksContainer.className = "animate-fade-in grid grid-cols-4 gap-4 [&>*:nth-child(9)]:col-start-2 md:grid md:grid-cols-10 md:gap-4 md:[&>*:nth-child(9)]:col-start-auto";
            } else {
                linksContainer.className = "animate-fade-in grid grid-cols-2 sm:grid-cols-3 gap-3 [&>*:nth-child(10)]:sm:col-start-2";
            }

            const modifierName = getModifierKeyName();

            let html = linksToShow.map((link, index) => {
                let displayIndex = index + 1;
                if (displayIndex === 10) displayIndex = 0;

                const hotkeyDisplay = linkHotkeyMode === 'numeric' ? `${displayIndex}` : `${modifierName} + ${displayIndex}`;

                if (isIconMode) {
                    return `
                    <a href="${link.url}" ${preferences.openLinkNewTab ? 'target="_blank"' : ''}
                       class="group relative flex items-center justify-center p-3 rounded-xl 
                              bg-white dark:bg-zinc-800 
                              border border-zinc-200 dark:border-zinc-700 
                              hover:border-zinc-300 dark:hover:border-zinc-600
                              hover:scale-110 transition-all duration-300 shadow-sm
                              aspect-square w-full focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                        <img src="${getFavicon(link.url)}" alt="" class="w-8 h-8 rounded-sm object-contain opacity-90 group-hover:opacity-100" aria-hidden="true">
                         
                        <span class="sr-only">${link.name}</span>
                        <!-- Tooltip (hover only, not on focus) -->
                        <div class="absolute -bottom-14 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 group-focus:opacity-0 transition-opacity duration-200 bg-zinc-800 text-white text-[10px] font-medium px-2 py-1.5 rounded shadow-lg whitespace-nowrap pointer-events-none z-10 translate-y-1 group-hover:translate-y-0 flex flex-col items-center gap-0.5">
                            <span>${link.name}</span>
                            ${showHotkeys ? `<span class="hidden sm:inline text-zinc-400 font-mono font-normal text-[9px]">${hotkeyDisplay}</span>` : ''}
                        </div>
                    </a>
                    `;
                } else {
                    return `
                    <a href="${link.url}" ${preferences.openLinkNewTab ? 'target="_blank"' : ''}
                       class="group flex items-center gap-3 p-3 rounded-xl 
                              bg-white/50 dark:bg-zinc-900/30 
                              border border-zinc-200/50 dark:border-zinc-800/50 
                              hover:bg-white/80 dark:hover:bg-zinc-800/50 
                              hover:border-zinc-300 dark:hover:border-zinc-700 
                              transition-all duration-200 shadow-sm dark:shadow-none relative
                              focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                        ${showHotkeys ? `
                        <div class="hidden sm:block absolute top-2 right-2 text-[10px] text-zinc-300 dark:text-zinc-700 font-mono font-normal opacity-0 group-hover:opacity-100 transition-opacity">
                            ${hotkeyDisplay}
                        </div>` : ''}
                        <div class="p-2 rounded-lg bg-white dark:bg-zinc-800 shadow-sm shrink-0">
                            <img src="${getFavicon(link.url)}" alt="${link.name}" class="w-4 h-4 rounded-sm opacity-90 group-hover:opacity-100">
                        </div>
                        <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400 group-hover:text-zinc-900 dark:group-hover:text-zinc-200 truncate pr-4">
                            ${link.name}
                        </span>
                    </a>
                    `;
                }
            }).join('');

            linksContainer.innerHTML = html;
            lucide.createIcons();
        }

        // --- Settings: Engine Management ---

        function renderSettingsEngines() {
            const sourceEngines = tempPreferences ? tempPreferences.engines : preferences.engines;
            const sourceDefaultSearch = tempPreferences ? tempPreferences.engineDefaultSearch : preferences.engineDefaultSearch;
            const sourceDefaultAsk = tempPreferences ? tempPreferences.engineDefaultAsk : preferences.engineDefaultAsk;

            settingEnginesList.innerHTML = sourceEngines.map((eng, index) => {
                const isSearch = eng.name === sourceDefaultSearch;
                const isAsk = eng.name === sourceDefaultAsk;
                const isEditing = index === editingEngineIndex;

                let borderClass = 'border-zinc-100 dark:border-zinc-800';

                if (isSearch && isAsk) {
                    borderClass = 'border-indigo-200 dark:border-indigo-900/30';
                } else if (isSearch) {
                    borderClass = 'border-blue-200 dark:border-blue-900/30';
                } else if (isAsk) {
                    borderClass = 'border-purple-200 dark:border-purple-900/30';
                }

                let containerClass = `flex items-center justify-between p-3 rounded-lg border group transition-all duration-200 bg-zinc-50 dark:bg-zinc-800/50 ${borderClass}`;

                let editBtnClass = "p-2 rounded-md transition-colors";
                if (isEditing) {
                    editBtnClass += " bg-yellow-100 text-yellow-700 dark:bg-yellow-500/30 dark:text-yellow-200";
                } else {
                    editBtnClass += " text-zinc-300 hover:text-yellow-600 dark:text-zinc-500 hover:bg-yellow-50 dark:hover:bg-yellow-500/10 dark:hover:text-yellow-300";
                }

                return `
                <div class="${containerClass}">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <img src="${getFavicon(eng.url)}" class="w-5 h-5 rounded-sm shrink-0">
                        <div class="flex flex-col overflow-hidden">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-zinc-900 dark:text-zinc-200 truncate">${eng.name}</span>
                                ${eng.shortcut ? `<span class="whitespace-nowrap text-[10px] text-zinc-500 dark:text-zinc-400 font-mono bg-zinc-100 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 px-1.5 rounded">${eng.shortcut}</span>` : ''}
                            </div>
                            <span class="text-xs text-zinc-400 truncate">${eng.url}</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-1">
                         <!-- Search Default Toggle -->
                        <button onclick="setDefaultSearch(${index})" class="p-2 rounded-md transition-colors ${isSearch ? 'bg-blue-100 text-blue-700 dark:bg-blue-500/30 dark:text-blue-200' : 'text-zinc-300 hover:text-blue-600 dark:text-zinc-500 hover:bg-blue-50 dark:hover:bg-blue-500/10 dark:hover:text-blue-300'}" title="Set as default Search Engine">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </button>
                        
                        <!-- Ask Default Toggle -->
                        <button onclick="setDefaultAsk(${index})" class="p-2 rounded-md transition-colors ${isAsk ? 'bg-purple-100 text-purple-700 dark:bg-purple-500/30 dark:text-purple-200' : 'text-zinc-300 hover:text-purple-600 dark:text-zinc-500 hover:bg-purple-50 dark:hover:bg-purple-500/10 dark:hover:text-purple-300'}" title="Set as default Ask Engine">
                            <i data-lucide="search-slash" class="w-4 h-4"></i>
                        </button>

                        <div class="w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1"></div>
                        
                        <!-- Edit Button -->
                        <button onclick="editEngine(${index})" class="${editBtnClass}" title="Edit Engine">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>

                        <!-- Delete Button -->
                        ${sourceEngines.length > 1 ? `
                        <button onclick="deleteEngine(${index}, this)" class="p-2 text-zinc-300 hover:text-red-600 dark:text-zinc-500 hover:bg-red-50 dark:hover:bg-red-500/10 dark:hover:text-red-300 rounded-md transition-colors" title="Delete Engine">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        window.setDefaultSearch = function (index) {
            tempPreferences.engineDefaultSearch = tempPreferences.engines[index].name;
            renderSettingsEngines();
            checkDirtyState();
        };

        window.setDefaultAsk = function (index) {
            tempPreferences.engineDefaultAsk = tempPreferences.engines[index].name;
            renderSettingsEngines();
            checkDirtyState();
        };

        window.deleteEngine = function (index, btn) {
            const currentEngines = tempPreferences.engines;

            // If we're editing this engine, cancel edit first and find the new button after re-render.
            if (editingEngineIndex === index) {
                cancelEngineEdit();
                const engineItems = settingEnginesList.querySelectorAll(':scope > div');
                if (engineItems[index]) {
                    btn = engineItems[index].querySelector('button[title="Delete Engine"]');
                    if (!btn) return;
                } else {
                    return;
                }
            }

            // Delete Confirmation Logic
            if (!btn.dataset.confirm || btn.dataset.confirm === 'false') {
                btn.dataset.confirm = 'true';
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i>`;
                btn.classList.add('bg-red-100', 'text-red-700', 'dark:bg-red-500/30', 'dark:text-red-200');
                btn.classList.remove('text-zinc-300', 'hover:text-red-600', 'dark:text-zinc-500', 'hover:bg-red-50', 'dark:hover:bg-red-500/10', 'dark:hover:text-red-300');
                lucide.createIcons();
                setTimeout(() => {
                    if (document.body.contains(btn)) {
                        btn.dataset.confirm = 'false';
                        btn.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i>`;
                        btn.classList.remove('bg-red-100', 'text-red-700', 'dark:bg-red-500/30', 'dark:text-red-200');
                        btn.classList.add('text-zinc-300', 'dark:text-zinc-500', 'hover:text-red-600', 'hover:bg-red-50', 'dark:hover:bg-red-500/10', 'dark:hover:text-red-300');
                        lucide.createIcons();
                    }
                }, 2000);
                return;
            }

            // Actual Delete Logic
            if (currentEngines.length <= 1) return;

            const deletedEngineName = currentEngines[index].name;

            if (editingEngineIndex > index) editingEngineIndex--;

            currentEngines.splice(index, 1);

            // If the deleted engine was a default, fallback to first remaining engine.
            if (tempPreferences.engineDefaultSearch === deletedEngineName) {
                tempPreferences.engineDefaultSearch = currentEngines[0].name;
            }
            if (tempPreferences.engineDefaultAsk === deletedEngineName) {
                tempPreferences.engineDefaultAsk = currentEngines[0].name;
            }

            renderSettingsEngines();
            checkDirtyState();
        };

        window.editEngine = function (index) {
            const engine = tempPreferences.engines[index];
            newEngineName.value = engine.name;
            newEngineShortcut.value = engine.shortcut || '';
            newEngineUrl.value = engine.url;
            editingEngineIndex = index;
            saveEngineBtn.textContent = 'Update Engine';
            cancelEngineEditBtn.classList.remove('hidden');
            hideError(settingEngineFormError);
            settingEngineForm.scrollIntoView({ behavior: 'smooth' });
            renderSettingsEngines();
        };

        window.cancelEngineEdit = function () {
            newEngineName.value = '';
            newEngineShortcut.value = '';
            newEngineUrl.value = '';
            editingEngineIndex = null;
            saveEngineBtn.textContent = 'Add Engine';
            cancelEngineEditBtn.classList.add('hidden');
            hideError(settingEngineFormError);
            renderSettingsEngines();
        };

        function saveEngine() {
            const name = newEngineName.value.trim();
            const shortcut = newEngineShortcut.value.trim();
            let url = newEngineUrl.value.trim();

            if (!name || !url) {
                showError(settingEngineFormError, 'Please enter a valid Name and URL.');
                return;
            }

            if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

            hideError(settingEngineFormError);

            const currentEngines = tempPreferences.engines;

            if (shortcut) {
                if (shortcut === '?') {
                    showError(settingEngineFormError, "The shortcut '?' is reserved for Ask Engine.");
                    return;
                }
                const duplicateShortcut = currentEngines.find((e, i) => (editingEngineIndex === null || i !== editingEngineIndex) && e.shortcut === shortcut);
                if (duplicateShortcut) {
                    showError(settingEngineFormError, `Shortcut '${shortcut}' already taken by the engine '${duplicateShortcut.name}'.`);
                    return;
                }
            }

            if (editingEngineIndex !== null) {
                currentEngines[editingEngineIndex] = { name, shortcut, url };
                cancelEngineEdit();
            } else {
                currentEngines.push({ name, shortcut, url });
                newEngineName.value = '';
                newEngineShortcut.value = '';
                newEngineUrl.value = '';
            }

            renderSettingsEngines();
            checkDirtyState();
        }

        // --- Settings: Speed Dial/Link Management ---

        function renderSettingsLinks() {
            const sourceLinks = tempPreferences ? tempPreferences.links : preferences.links;
            const sourceHotkeyMode = tempPreferences ? tempPreferences.linkHotkeyMode : preferences.linkHotkeyMode;
            const sourceEnableHotkeys = sourceHotkeyMode !== 'disabled';

            linkCount.textContent = `(${sourceLinks.length})`;

            saveLinkBtn.disabled = false;
            if (editingLinkIndex === null) {
                saveLinkBtn.textContent = "Add Link";
            }
            newLinkName.disabled = false;
            newLinkUrl.disabled = false;

            if (sourceLinks.length === 0) {
                settingLinksList.innerHTML = `<p class="text-center text-sm text-zinc-400 py-4 italic">No speed dial links added.</p>`;
                return;
            }

            settingLinksList.innerHTML = sourceLinks.map((link, index) => {
                const isEditing = index === editingLinkIndex;
                let displayIndex = index + 1;
                if (index === 9) displayIndex = 0; // Show 0 for 10th item

                let containerClass = "flex items-center justify-between p-3 rounded-lg border group transition-all duration-200 bg-zinc-50 dark:bg-zinc-800/50 border-zinc-100 dark:border-zinc-800";

                let editBtnClass = "p-2 rounded-md transition-colors";
                if (isEditing) {
                    editBtnClass += " bg-yellow-100 text-yellow-700 dark:bg-yellow-500/30 dark:text-yellow-200";
                } else {
                    editBtnClass += " text-zinc-300 hover:text-yellow-600 dark:text-zinc-500 hover:bg-yellow-50 dark:hover:bg-yellow-500/10 dark:hover:text-yellow-300";
                }

                return `
                <div class="${containerClass}"
                     draggable="true"
                     data-index="${index}">
                    
                    <div class="flex items-center gap-3 overflow-hidden pointer-events-none">
                        <img src="${getFavicon(link.url)}" class="w-5 h-5 rounded-sm shrink-0">
                        <div class="flex flex-col overflow-hidden">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-zinc-900 dark:text-zinc-200 truncate">${link.name}</span>
                                ${(index < 10 && sourceEnableHotkeys) ? `<span class="text-[10px] text-zinc-500 dark:text-zinc-400 font-mono bg-zinc-100 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 px-1.5 rounded">${displayIndex}</span>` : ''}
                                ${link.shortcut ? `<span class="whitespace-nowrap text-[10px] text-zinc-500 dark:text-zinc-400 font-mono bg-zinc-100 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 px-1.5 rounded">${link.shortcut}</span>` : ''}
                            </div>
                            <span class="text-xs text-zinc-400 truncate">${link.url}</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-1">
                        <div class="drag-handle p-2 text-zinc-300 hover:text-zinc-500 dark:text-zinc-600 dark:hover:text-zinc-400 cursor-grab active:cursor-grabbing transition-colors">
                            <i data-lucide="grip-vertical" class="w-4 h-4"></i>
                        </div>
                        <button onclick="editLink(${index})" class="${editBtnClass}" title="Edit Link">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteLink(${index}, this)" class="p-2 text-zinc-300 hover:text-red-600 dark:text-zinc-500 hover:bg-red-50 dark:hover:bg-red-500/10 dark:hover:text-red-300 rounded-md transition-colors" title="Delete Link">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `}).join('');

            lucide.createIcons();
            attachDragListeners();
        }

        window.editLink = function (index) {
            const link = tempPreferences.links[index];
            newLinkName.value = link.name;
            newLinkShortcut.value = link.shortcut || '';
            newLinkUrl.value = link.url;
            editingLinkIndex = index;
            saveLinkBtn.textContent = "Update Link";
            saveLinkBtn.disabled = false;
            newLinkName.disabled = false;
            newLinkUrl.disabled = false;
            cancelLinkEditBtn.classList.remove('hidden');
            hideError(settingLinkFormError);
            settingLinkForm.scrollIntoView({ behavior: 'smooth' });
            renderSettingsLinks();
        }

        window.cancelLinkEdit = function () {
            newLinkName.value = '';
            newLinkShortcut.value = '';
            newLinkUrl.value = '';
            editingLinkIndex = null;
            saveLinkBtn.textContent = "Add Link";
            cancelLinkEditBtn.classList.add('hidden');
            hideError(settingLinkFormError);
            renderSettingsLinks();
        }

        function saveLink() {
            const name = newLinkName.value.trim();
            const shortcut = newLinkShortcut.value.trim();
            let url = newLinkUrl.value.trim();

            if (!name || !url) {
                showError(settingLinkFormError, 'Please enter a valid Name and URL.');
                return;
            }

            url = formatUrl(url);

            hideError(settingLinkFormError);

            const currentLinks = tempPreferences.links;

            if (shortcut) {
                if (shortcut === '?') {
                    showError(settingLinkFormError, "The shortcut '?' is reserved for Ask Engine.");
                    return;
                }
                const duplicateShortcut = currentLinks.find((l, i) => (editingLinkIndex === null || i !== editingLinkIndex) && l.shortcut === shortcut);
                if (duplicateShortcut) {
                    showError(settingLinkFormError, `Shortcut '${shortcut}' already taken by the link '${duplicateShortcut.name}'.`);
                    return;
                }
            }

            if (editingLinkIndex !== null) {
                currentLinks[editingLinkIndex] = { name, shortcut, url };
                cancelLinkEdit();
            } else {
                currentLinks.push({ name, shortcut, url });
                newLinkName.value = '';
                newLinkShortcut.value = '';
                newLinkUrl.value = '';
            }

            renderSettingsLinks();
            checkDirtyState();
        }

        window.deleteLink = function (index, btn) {
            // If we're editing this link, cancel edit first and find the new button after re-render.
            if (editingLinkIndex === index) {
                cancelLinkEdit();
                const linkItems = settingLinksList.querySelectorAll(':scope > div[draggable="true"]');
                if (linkItems[index]) {
                    btn = linkItems[index].querySelector('button[title="Delete Link"]');
                    if (!btn) return;
                } else {
                    return;
                }
            }

            // Delete Confirmation Logic
            if (!btn.dataset.confirm || btn.dataset.confirm === 'false') {
                btn.dataset.confirm = 'true';
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i>`;
                btn.classList.add('bg-red-100', 'text-red-700', 'dark:bg-red-500/30', 'dark:text-red-200');
                btn.classList.remove('text-zinc-300', 'hover:text-red-600', 'dark:text-zinc-500', 'hover:bg-red-50', 'dark:hover:bg-red-500/10', 'dark:hover:text-red-300');
                lucide.createIcons();
                setTimeout(() => {
                    if (document.body.contains(btn)) {
                        btn.dataset.confirm = 'false';
                        btn.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i>`;
                        btn.classList.remove('bg-red-100', 'text-red-700', 'dark:bg-red-500/30', 'dark:text-red-200');
                        btn.classList.add('text-zinc-300', 'dark:text-zinc-500', 'hover:text-red-600', 'hover:bg-red-50', 'dark:hover:bg-red-500/10', 'dark:hover:text-red-300');
                        lucide.createIcons();
                    }
                }, 2000);
                return;
            }

            // Actual Delete Logic
            if (editingLinkIndex > index) editingLinkIndex--;

            tempPreferences.links.splice(index, 1);

            renderSettingsLinks();
            checkDirtyState();
        };

        // --- Speed Dial: Drag & Drop Logic ---

        let dragListenerInitialized = false;
        function initDragListener() {
            if (dragListenerInitialized) return;
            dragListenerInitialized = true;
            settingLinksList.addEventListener('mousedown', (e) => {
                lastMouseDownTarget = e.target;
            });
        }

        function attachDragListeners() {
            initDragListener();
            const items = settingLinksList.querySelectorAll('div[draggable="true"]');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            if (!lastMouseDownTarget || !lastMouseDownTarget.closest('.drag-handle')) {
                e.preventDefault();
                return;
            }
            draggedItem = e.target.closest('[draggable]');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', '');
            requestAnimationFrame(() => {
                draggedItem.classList.add('dragging');
                draggedItem.style.opacity = '0.5';
            });
        }

        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }

        function handleDragEnter(e) {
            e.preventDefault();
            const target = e.target.closest('[draggable]');
            if (target && target !== draggedItem) target.classList.add('bg-zinc-100', 'dark:bg-zinc-800');
        }

        function handleDragLeave(e) {
            const target = e.target.closest('[draggable]');
            if (target && target !== draggedItem) target.classList.remove('bg-zinc-100', 'dark:bg-zinc-800');
        }

        function handleDrop(e) {
            e.stopPropagation();
            const targetItem = e.target.closest('[draggable]');

            if (draggedItem) { draggedItem.classList.remove('dragging'); draggedItem.style.opacity = '1'; }
            document.querySelectorAll('.bg-zinc-100, .dark\\:bg-zinc-800').forEach(el => {
                if (el !== draggedItem) el.classList.remove('bg-zinc-100', 'dark:bg-zinc-800');
            });

            if (draggedItem && targetItem && draggedItem !== targetItem) {
                const fromIndex = parseInt(draggedItem.getAttribute('data-index'));
                const toIndex = parseInt(targetItem.getAttribute('data-index'));

                const currentLinks = tempPreferences.links;
                const itemToMove = currentLinks[fromIndex];
                currentLinks.splice(fromIndex, 1);
                currentLinks.splice(toIndex, 0, itemToMove);

                if (editingLinkIndex === fromIndex) editingLinkIndex = toIndex;

                renderSettingsLinks();
                checkDirtyState();
            }

            return false;
        }

        // --- Theme Handling ---

        function applyTheme() {
            const isDark = preferences.theme === 'dark' ||
                (preferences.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);

            if (isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');

            const themeColor = isDark ? '#09090b' : '#f5f5f5';
            document.querySelectorAll('meta[name="theme-color"]').forEach(meta => {
                meta.setAttribute('content', themeColor);
            });

            updateThemeIcon();
        }

        function updateThemeIcon() {
            let iconName = 'moon';
            if (preferences.theme === 'light') iconName = 'sun';
            if (preferences.theme === 'auto') iconName = 'sun-moon';
            themeToggle.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4"></i>`;
            lucide.createIcons();
        }

        function cycleTheme() {
            const modes = ['dark', 'light', 'auto'];
            const nextIndex = (modes.indexOf(preferences.theme) + 1) % modes.length;
            preferences.theme = modes[nextIndex];
            localStorage.setItem('theme', preferences.theme);
            applyTheme();
        }

        // --- Data Management Functions (Reset, Import, Export) ---

        function handleResetSettings() {
            if (resetSettingsBtn.dataset.confirm === 'true') {
                localStorage.clear();
                sessionStorage.clear();
                window.location.reload();
            } else {
                resetSettingsBtn.dataset.confirm = 'true';
                resetSettingsBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i>`;
                resetSettingsBtn.classList.add('bg-red-100', 'text-red-700', 'dark:bg-red-500/30', 'dark:text-red-200');
                resetSettingsBtn.classList.remove('text-zinc-400', 'hover:text-red-500', 'hover:bg-red-50', 'dark:hover:bg-red-900/20');
                lucide.createIcons();
                resetConfirmTimeout = setTimeout(() => {
                    resetSettingsBtn.dataset.confirm = 'false';
                    resetSettingsBtn.innerHTML = `<i data-lucide="rotate-ccw" class="w-4 h-4"></i>`;
                    resetSettingsBtn.classList.remove('bg-red-100', 'text-red-700', 'dark:bg-red-500/30', 'dark:text-red-200');
                    resetSettingsBtn.classList.add('text-zinc-400', 'hover:text-red-500', 'hover:bg-red-50', 'dark:hover:bg-red-900/20');
                    lucide.createIcons();
                }, 2000);
            }
        }

        function handleExportSettings() {
            const orderedPreferences = {
                theme: preferences.theme,
                username: preferences.username,
                enableGreetings: preferences.enableGreetings,
                autofocusInput: preferences.autofocusInput,
                openQueryNewTab: preferences.openQueryNewTab,
                openLinkNewTab: preferences.openLinkNewTab,
                dateFormat: preferences.dateFormat,
                showWeekday: preferences.showWeekday,
                showYear: preferences.showYear,
                showLeadingZero: preferences.showLeadingZero,
                timeFormat: preferences.timeFormat,
                showAmPm: preferences.showAmPm,
                showSeconds: preferences.showSeconds,
                flashSeparators: preferences.flashSeparators,
                engines: preferences.engines.map(e => ({ name: e.name, shortcut: e.shortcut, url: e.url })),
                engineDefaultSearch: preferences.engineDefaultSearch,
                engineDefaultAsk: preferences.engineDefaultAsk,
                engineTriggerKey: preferences.engineTriggerKey,
                engineMatchMode: preferences.engineMatchMode,
                showSpeedDial: preferences.showSpeedDial,
                links: preferences.links.map(l => ({ name: l.name, shortcut: l.shortcut, url: l.url })),
                linkLayout: preferences.linkLayout,
                linkMatchMode: preferences.linkMatchMode,
                linkHotkeyMode: preferences.linkHotkeyMode,
                linkAutoOpen: preferences.linkAutoOpen
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(orderedPreferences, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "startpage_settings.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function handleImportSettings() {
            importFileInput.click();
        }

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported && typeof imported === 'object') {
                        preferences = { ...preferences, ...imported };
                        persistPreferences();
                        window.location.reload();
                    } else {
                        alert("Invalid settings file.");
                    }
                } catch (err) {
                    console.error("Error parsing settings file:", err);
                    alert("Error parsing settings file.");
                }
            };
            reader.readAsText(file);
            importFileInput.value = '';
        });

        // --- Help Modal Handling ---
        function openHelp() {
            history.pushState({ modal: 'help' }, '', '');
            helpModal.classList.remove('hidden');
            setTimeout(() => helpModal.classList.add('modal-active'), 10);
        }

        function closeHelpUI() {
            helpModal.classList.remove('modal-active');
            setTimeout(() => helpModal.classList.add('hidden'), 600);
            helpToggle.blur();
        }

        function closeHelp() {
            if (history.state && history.state.modal === 'help') {
                history.back();
            } else {
                closeHelpUI();
            }
        }

        // --- Settings Modal Handling ---

        function checkDirtyState() {
            if (!tempPreferences) return false;

            const isDirty = JSON.stringify(tempPreferences) !== originalPreferencesSnapshot;

            if (isDirty) {
                // Active/Colored State
                saveSettingsBtn.classList.remove('bg-zinc-200', 'dark:bg-zinc-700', 'text-zinc-400', 'dark:text-zinc-500', 'cursor-not-allowed');
                saveSettingsBtn.classList.add('bg-zinc-900', 'dark:bg-white', 'text-white', 'dark:text-zinc-900', 'hover:opacity-90', 'cursor-pointer');
            } else {
                // Inactive/Gray State (but still clickable to close)
                saveSettingsBtn.classList.remove('bg-zinc-900', 'dark:bg-white', 'text-white', 'dark:text-zinc-900', 'hover:opacity-90');
                saveSettingsBtn.classList.add('bg-zinc-200', 'dark:bg-zinc-700', 'text-zinc-400', 'dark:text-zinc-500');
            }

            return isDirty;
        }

        window.openSettings = function (section) {
            // Push history state
            history.pushState({ modal: 'settings' }, '', '');

            // 1. Create a deep copy for temporary editing
            tempPreferences = JSON.parse(JSON.stringify(preferences));
            originalPreferencesSnapshot = JSON.stringify(preferences);

            // 2. Populate Form Inputs from tempPreferences
            settingUsername.value = tempPreferences.username;
            settingEnableGreetings.checked = tempPreferences.enableGreetings;
            settingAutofocusInput.checked = tempPreferences.autofocusInput;
            settingOpenQueryNewTab.checked = tempPreferences.openQueryNewTab;
            settingOpenLinkNewTab.checked = tempPreferences.openLinkNewTab;
            settingDateFormat.value = tempPreferences.dateFormat;
            settingShowWeekday.checked = tempPreferences.showWeekday;
            settingShowYear.checked = tempPreferences.showYear;
            settingShowLeadingZero.checked = tempPreferences.showLeadingZero;
            settingShowAmPm.checked = tempPreferences.showAmPm;
            settingShowSeconds.checked = tempPreferences.showSeconds;
            settingFlashSeparators.checked = tempPreferences.flashSeparators;
            settingEngineTriggerKey.value = tempPreferences.engineTriggerKey || 'both';
            settingEngineMatchMode.value = tempPreferences.engineMatchMode || 'shortcut';
            settingShowSpeedDial.checked = tempPreferences.showSpeedDial;
            settingLinkMatchMode.value = tempPreferences.linkMatchMode || 'shortcut';
            settingLinkHotkeyMode.value = tempPreferences.linkHotkeyMode || 'alt';
            settingLinkAutoOpen.value = tempPreferences.linkAutoOpen || 'disabled';

            // 3. Update Visuals for Buttons
            updateDateFormatOptions();
            updateTimeFormatOptions();
            updateLayoutViewUI();

            // 4. Render Lists (using tempPreferences)
            renderSettingsEngines();
            renderSettingsLinks();

            // 5. Reset internal states
            cancelEngineEdit();
            cancelLinkEdit();
            settingsModal.classList.remove('hidden');
            setTimeout(() => settingsModal.classList.add('modal-active'), 10);

            // Reset Warning State on Open
            closeWarningActive = false;
            if (closeWarningTimeout) clearTimeout(closeWarningTimeout);

            if (section === 'engines') {
                document.getElementById('setting-engines-section').scrollIntoView({ behavior: 'smooth' });
            }

            checkDirtyState();
        }

        function updateDateFormatOptions() {
            if (!tempPreferences) return;
            const now = new Date();
            const year = now.getFullYear();
            const day = now.getDate();
            const monthIndex = now.getMonth();
            const shortMonth = now.toLocaleDateString('en-US', { month: 'short' });
            const longMonth = now.toLocaleDateString('en-US', { month: 'long' });
            const shortWeekday = now.toLocaleDateString('en-US', { weekday: 'short' });
            const longWeekday = now.toLocaleDateString('en-US', { weekday: 'long' });
            const formatNum = (num) => {
                if (tempPreferences.showLeadingZero) {
                    return num.toString().padStart(2, '0');
                }
                return num.toString();
            };
            const getFormatString = (type) => {
                let text = '';
                switch (type) {
                    case 'short':
                        text = `${shortMonth} ${formatNum(day)}`;
                        if (tempPreferences.showYear) text += ` ${year}`;
                        break;
                    case 'long':
                        text = `${longMonth} ${formatNum(day)}`;
                        if (tempPreferences.showYear) text += `, ${year}`;
                        break;
                    case 'numeric':
                        text = `${formatNum(day)}/${formatNum(monthIndex + 1)}`;
                        if (tempPreferences.showYear) text += `/${year}`;
                        break;
                }
                if (tempPreferences.showWeekday) {
                    const weekday = type === 'short' ? shortWeekday : longWeekday;
                    text = `${weekday}, ${text}`;
                }
                return text;
            };

            const options = settingDateFormat.options;
            for (let i = 0; i < options.length; i++) {
                const opt = options[i];
                let label = '';
                if (opt.value === 'short') label = 'Short';
                else if (opt.value === 'long') label = 'Long';
                else if (opt.value === 'numeric') label = 'Numeric';
                opt.textContent = `${label} (${getFormatString(opt.value)})`;
            }
        }

        function updateTimeFormatOptions() {
            settingTimeFormat.forEach(btn => {
                const isActive = btn.dataset.value === tempPreferences.timeFormat;
                btn.className = `format-btn p-2 rounded-lg border text-sm font-medium transition-all ${isActive
                    ? 'bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 border-zinc-900 dark:border-white'
                    : 'border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-400'
                    }`;
            });
            if (settingShowAmPm) {
                const is24 = tempPreferences.timeFormat === '24';
                settingShowAmPm.disabled = is24;
                if (is24) {
                    settingShowAmPm.parentElement.classList.add('opacity-50');
                } else {
                    settingShowAmPm.parentElement.classList.remove('opacity-50');
                }
            }
        }

        function updateLayoutViewUI() {
            const isEnabled = tempPreferences && tempPreferences.showSpeedDial;
            settingLinkLayoutView.forEach(btn => {
                const isActive = btn.dataset.value === tempPreferences.linkLayout;
                let classes = `setting-link-layout-view p-2 rounded-lg border flex items-center justify-center gap-2 text-sm font-medium transition-all `;
                if (!isEnabled) {
                    classes += 'border-zinc-100 dark:border-zinc-800 text-zinc-300 dark:text-zinc-600 cursor-not-allowed opacity-50';
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                    classes += 'cursor-pointer ';
                    if (isActive) {
                        classes += 'bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 border-zinc-900 dark:border-white';
                    } else {
                        classes += 'border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-400';
                    }
                }
                btn.className = classes;
            });
        }

        function closeSettingsUI() {
            tempPreferences = null;
            originalPreferencesSnapshot = null;
            settingsModal.classList.remove('modal-active');
            setTimeout(() => settingsModal.classList.add('hidden'), 600);
            settingsToggle.blur();
            if (resetConfirmTimeout) clearTimeout(resetConfirmTimeout);
            resetSettingsBtn.dataset.confirm = 'false';
            resetSettingsBtn.innerHTML = `<i data-lucide="rotate-ccw" class="w-4 h-4"></i>`;
            resetSettingsBtn.classList.remove('bg-red-100', 'text-red-700', 'dark:bg-red-500/30', 'dark:text-red-200');
            resetSettingsBtn.classList.add('text-zinc-400', 'hover:text-red-500', 'hover:bg-red-50', 'dark:hover:bg-red-900/20');
            lucide.createIcons();
        }

        function closeSettings() {
            if (history.state && history.state.modal === 'settings') {
                history.back();
            } else {
                closeSettingsUI();
            }
        }

        function handleCloseSettingsClick() {
            // 1. If not dirty, just close
            if (!checkDirtyState()) {
                closeSettings();
                return;
            }

            // 2. If dirty, check if warning is already active; second click -> force close = discard changes
            if (closeWarningActive) {
                closeSettings();
                return;
            }

            // 3. First click with dirty state -> warn
            closeWarningActive = true;

            // Warning
            const content = settingsModal.querySelector('.modal-content');
            content.classList.remove('animate-shake');
            void content.offsetWidth;
            content.classList.add('animate-shake');
            setTimeout(() => content.classList.remove('animate-shake'), 400);

            // Reset warning after 5 seconds
            if (closeWarningTimeout) clearTimeout(closeWarningTimeout);
            closeWarningTimeout = setTimeout(() => {
                closeWarningActive = false;
            }, 5000);
        }

        function saveSettings() {
            // 1. If no changes, just close
            if (!checkDirtyState()) {
                closeSettings();
                return;
            }

            // 2. Commit tempPreferences to actual preferences
            preferences = JSON.parse(JSON.stringify(tempPreferences));

            // 3. Persist to LocalStorage
            persistPreferences();

            // 4. Update Main UI
            updateDateTime();
            updateGreetingUI();
            renderLinks();

            // 5. Close
            tempPreferences = null;
            closeSettings();
        }

        // --- Event Listeners ---

        applyTheme();
        updateDateTime();
        setInterval(updateDateTime, 1000);
        updateGreetingUI();
        renderLinks();

        // Auto-focus Logic
        if (preferences.autofocusInput) {
            mainInput.focus();
        }

        lucide.createIcons();

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (preferences.theme === 'auto') applyTheme();
        });

        // Handle click on the action indicator
        actionBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            if (!mainInput.value.trim()) {
                mainInput.focus();
                return;
            }

            mainForm.dispatchEvent(new Event('submit'));
        });

        // Handle clicks on Speed Dial Links
        linksContainer.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && preferences.openLinkNewTab) {
                clearAndResetInput();
            }
        });

        mainForm.addEventListener('submit', (e) => {
            e.preventDefault();
            let query = mainInput.value.trim();
            if (query) {
                // 1. Check for Speed Dial Links
                const speedDialLink = findMatchingLink(query);
                let numericLink = null;

                if (!speedDialLink && preferences.linkHotkeyMode === 'numeric') {
                    const index = getLinkIndexFromNumericKey(query);
                    if (index >= 0 && index < preferences.links.length) {
                        numericLink = preferences.links[index];
                    }
                }

                if (speedDialLink) {
                    if (preferences.openLinkNewTab) {
                        window.open(speedDialLink.url, '_blank', 'noopener,noreferrer');
                        clearAndResetInput();
                    } else {
                        window.location.href = speedDialLink.url;
                    }
                    return;
                }

                if (numericLink) {
                    if (preferences.openLinkNewTab) {
                        window.open(numericLink.url, '_blank', 'noopener,noreferrer');
                        clearAndResetInput();
                    } else {
                        window.location.href = numericLink.url;
                    }
                    return;
                }

                // 2. Check for Search & Ask Engines
                let engineIndex;

                // Priority: Active an engine (from Tab or validated Space)
                if (activeActionEngine && query.startsWith(activeActionEngine.shortcut)) {
                    const parts = query.split(' ');
                    if (parts[0] === activeActionEngine.shortcut && parts.length > 1) {
                        const engine = activeActionEngine;
                        query = parts.slice(1).join(' ');
                        let url = engine.url;
                        if (url.includes('%s')) {
                            url = url.replaceAll('%s', encodeURIComponent(query));
                        } else {
                            url = url + encodeURIComponent(query);
                        }
                        if (preferences.openQueryNewTab) {
                            window.open(url, '_blank', 'noopener,noreferrer');
                            clearAndResetInput();
                        } else {
                            window.location.href = url;
                        }
                        return;
                    }
                }

                // Standard Parsing Logic (Fallback or Default Behavior)
                const parts = query.split(' ');
                if (parts.length > 1 && (preferences.engineTriggerKey === 'space' || preferences.engineTriggerKey === 'both')) {
                    const firstWord = parts[0];
                    const matchedEngine = findMatchingEngine(firstWord);
                    const triggeredEngineIndex = matchedEngine ? preferences.engines.indexOf(matchedEngine) : -1;
                    if (triggeredEngineIndex !== -1) {
                        engineIndex = triggeredEngineIndex;
                        query = parts.slice(1).join(' ');
                    }
                }

                // If no match is detected, determine engine by input triggers
                let engineName;
                if (engineIndex !== undefined) {
                    // An input triggers an engine - get the engine name
                    engineName = preferences.engines[engineIndex]?.name;
                } else if (query.startsWith('?') || query.endsWith('?')) {
                    // Ask Engine ('? query' OR 'query ?')
                    engineName = preferences.engineDefaultAsk;
                    if (query.startsWith('?')) {
                        query = query.substring(1).trim();
                    } else {
                        query = query.substring(0, query.length - 1).trim();
                    }
                } else {
                    // Search Engine
                    engineName = preferences.engineDefaultSearch;
                }

                // Find engine by name, fallback to first engine
                const engine = preferences.engines.find(e => e.name === engineName) || preferences.engines[0];

                let url = engine.url;
                if (url.includes('%s')) {
                    url = url.replaceAll('%s', encodeURIComponent(query));
                } else {
                    url = url + encodeURIComponent(query);
                }

                if (preferences.openQueryNewTab) {
                    window.open(url, '_blank', 'noopener,noreferrer');
                    clearAndResetInput();
                } else {
                    window.location.href = url;
                }
            }
        });

        // Input listener for Enter vs Space vs Action Detection
        mainInput.addEventListener('input', (e) => {
            const val = e.target.value;
            const parts = val.trim().split(/\s+/);
            const potentialTrigger = parts[0];
            const hasTrailingSpace = val.endsWith(' ');

            // Clear any pending auto-open
            if (autoOpenTimeout) {
                clearTimeout(autoOpenTimeout);
                autoOpenTimeout = null;
            }

            // --- State Management for Triggers ---

            // 1. Invalidate active engine if text no longer matches
            if (activeActionEngine) {
                if (!val.startsWith(activeActionEngine.shortcut + ' ')) {
                    activeActionEngine = null;
                }
            }

            // 2. Detect Space Trigger
            if (!activeActionEngine && (preferences.engineTriggerKey === 'space' || preferences.engineTriggerKey === 'both')) {
                if (val.endsWith(' ') && parts.length === 1 && parts[0].length > 0) {
                    const candidate = parts[0];
                    const found = findMatchingEngine(candidate);
                    if (found) {
                        activeActionEngine = found;
                    }
                }
            }

            // --- UI Updates ---

            if (val.length > 0) {
                actionSpace.classList.add('hidden');
                actionSpace.classList.remove('sm:inline-flex');
                actionEnter.classList.add('flex');
                actionEnter.classList.remove('hidden');

                // Base classes
                const baseClasses = ['items-center', 'gap-1.5', 'px-2.5', 'py-1', 'text-xs', 'font-medium', 'rounded', 'border', 'transition-all', 'flex', '[@media(hover:hover)]:group-hover/action:shadow-[0_0_15px_rgba(0,0,0,0.1)]', '[@media(hover:hover)]:dark:group-hover/action:shadow-[0_0_15px_rgba(0,0,0,0.5)]'];

                // Colors
                const searchClasses = ['text-blue-600', 'dark:text-blue-400', 'bg-blue-50', 'dark:bg-blue-500/10', 'border-blue-100', 'dark:border-blue-500/20', 'group-hover/action:border-blue-200', 'dark:group-hover/action:border-blue-500/50'];
                const askClasses = ['text-purple-600', 'dark:text-purple-400', 'bg-purple-50', 'dark:bg-purple-500/10', 'border-purple-100', 'dark:border-purple-500/20', 'group-hover/action:border-purple-200', 'dark:group-hover/action:border-purple-500/50'];
                const engineMatchClasses = ['text-emerald-600', 'dark:text-emerald-400', 'bg-emerald-50', 'dark:bg-emerald-500/10', 'border-emerald-100', 'dark:border-emerald-500/20', 'group-hover/action:border-emerald-200', 'dark:group-hover/action:border-emerald-500/50'];
                const linkClasses = ['text-orange-600', 'dark:text-orange-400', 'bg-orange-50', 'dark:bg-orange-500/10', 'border-orange-100', 'dark:border-orange-500/20', 'group-hover/action:border-orange-200', 'dark:group-hover/action:border-orange-500/50'];

                // Determine what to show in the UI
                let engineToShow = null;
                let linkToShow = null;

                // Check for Speed Dial Link Match (Exact match AND strict - no trailing space if trying to search)
                if (parts.length === 1 && !hasTrailingSpace) {
                    // 1. Exact string match
                    linkToShow = findMatchingLink(parts[0]);

                    // 2. Numeric match (if hotkeys enabled)
                    if (!linkToShow && preferences.linkHotkeyMode === 'numeric') {
                        const index = getLinkIndexFromNumericKey(parts[0]);
                        if (index >= 0 && index < preferences.links.length) {
                            linkToShow = preferences.links[index];
                        }
                    }

                    // Handle Auto-Open
                    if (linkToShow && preferences.linkAutoOpen !== 'disabled') {
                        const targetUrl = linkToShow.url;
                        if (preferences.linkAutoOpen === 'immediate') {
                            if (preferences.openLinkNewTab) {
                                window.open(targetUrl, '_blank', 'noopener,noreferrer');
                                clearAndResetInput();
                            } else {
                                window.location.href = targetUrl;
                            }
                        } else if (preferences.linkAutoOpen.startsWith('delay_')) {
                            const delay = preferences.linkAutoOpen === 'delay_2s' ? 2000 : 1000;
                            autoOpenTimeout = setTimeout(() => {
                                if (preferences.openLinkNewTab) {
                                    window.open(targetUrl, '_blank', 'noopener,noreferrer');
                                    clearAndResetInput();
                                } else {
                                    window.location.href = targetUrl;
                                }
                            }, delay);
                        }
                    }
                }

                // A. Explicitly active engine (via Tab or Space trigger)
                if (activeActionEngine) {
                    engineToShow = activeActionEngine;
                }
                // B. Implicit detection (Preview)
                else if (preferences.engineTriggerKey === 'space' || preferences.engineTriggerKey === 'both') {
                    const found = findMatchingEngine(potentialTrigger);
                    if (found && parts.length > 1) engineToShow = found;
                }

                if (linkToShow) {
                    // Link Match takes visual priority if exact match
                    actionEnter.className = [...baseClasses, ...linkClasses].join(' ');
                    actionEnter.innerHTML = `<i data-lucide="mouse-pointer-click" class="w-3 h-3"></i> ${linkToShow.name}`;
                } else if (engineToShow) {
                    // Engine Match
                    actionEnter.className = [...baseClasses, ...engineMatchClasses].join(' ');
                    actionEnter.innerHTML = `<i data-lucide="search-code" class="w-3 h-3"></i> ${engineToShow.name}`;
                } else {
                    // Standard Logic
                    const isAsk = val.trim().startsWith('?') || val.trim().endsWith('?');
                    if (isAsk) {
                        actionEnter.className = [...baseClasses, ...askClasses].join(' ');
                        actionEnter.innerHTML = `<i data-lucide="search-slash" class="w-3 h-3"></i> Ask`;
                    } else {
                        actionEnter.className = [...baseClasses, ...searchClasses].join(' ');
                        actionEnter.innerHTML = `<i data-lucide="search" class="w-3 h-3"></i> Search`;
                    }
                }

                lucide.createIcons();

            } else {
                activeActionEngine = null;
                actionSpace.classList.add('sm:inline-flex');
                actionSpace.classList.remove('hidden');
                actionEnter.classList.add('hidden');
                actionEnter.classList.remove('flex');
            }
        });

        helpToggle.addEventListener('click', openHelp);
        themeToggle.addEventListener('click', cycleTheme);
        settingsToggle.addEventListener('click', () => openSettings());
        closeSettingsBtn.addEventListener('click', handleCloseSettingsClick);
        saveSettingsBtn.addEventListener('click', saveSettings);
        saveEngineBtn.addEventListener('click', saveEngine);
        cancelEngineEditBtn.addEventListener('click', cancelEngineEdit);
        saveLinkBtn.addEventListener('click', saveLink);
        cancelLinkEditBtn.addEventListener('click', cancelLinkEdit);

        // Data listeners
        resetSettingsBtn.addEventListener('click', handleResetSettings);
        importSettingsBtn.addEventListener('click', handleImportSettings);
        exportSettingsBtn.addEventListener('click', handleExportSettings);

        // --- Input Listeners for Dirty Checking ---

        const attachInputListener = (elem, key, isCheckbox = false) => {
            const evt = isCheckbox ? 'change' : 'input';
            elem.addEventListener(evt, (e) => {
                if (!tempPreferences) return;
                const val = isCheckbox ? e.target.checked : e.target.value;
                tempPreferences[key] = val;
                if (key === 'showWeekday' || key === 'showYear' || key === 'showLeadingZero') {
                    updateDateFormatOptions();
                }
                checkDirtyState();
            });
        };

        attachInputListener(settingUsername, 'username');
        attachInputListener(settingEnableGreetings, 'enableGreetings', true);
        attachInputListener(settingAutofocusInput, 'autofocusInput', true);
        attachInputListener(settingOpenQueryNewTab, 'openQueryNewTab', true);
        attachInputListener(settingOpenLinkNewTab, 'openLinkNewTab', true);
        attachInputListener(settingDateFormat, 'dateFormat');
        attachInputListener(settingShowWeekday, 'showWeekday', true);
        attachInputListener(settingShowYear, 'showYear', true);
        attachInputListener(settingShowLeadingZero, 'showLeadingZero', true);
        attachInputListener(settingShowAmPm, 'showAmPm', true);
        attachInputListener(settingShowSeconds, 'showSeconds', true);
        attachInputListener(settingFlashSeparators, 'flashSeparators', true);
        attachInputListener(settingEngineTriggerKey, 'engineTriggerKey');
        attachInputListener(settingEngineMatchMode, 'engineMatchMode');
        attachInputListener(settingLinkMatchMode, 'linkMatchMode');
        attachInputListener(settingLinkHotkeyMode, 'linkHotkeyMode');
        attachInputListener(settingLinkAutoOpen, 'linkAutoOpen');

        closeHelpBtn.addEventListener('click', closeHelp);

        settingTimeFormat.forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (!tempPreferences) return;
                tempPreferences.timeFormat = e.currentTarget.dataset.value;
                updateTimeFormatOptions();
                checkDirtyState();
            });
        });

        settingShowSpeedDial.addEventListener('change', (e) => {
            if (!tempPreferences) return;
            tempPreferences.showSpeedDial = e.target.checked;
            updateLayoutViewUI();
            checkDirtyState();
        });

        settingLinkLayoutView.forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (!tempPreferences || !tempPreferences.showSpeedDial) return; // Prevent click if disabled
                tempPreferences.linkLayout = e.currentTarget.dataset.value;
                updateLayoutViewUI();
                checkDirtyState();
            });
        });

        settingLinkHotkeyMode.addEventListener('change', (e) => {
            if (!tempPreferences) return;
            tempPreferences.linkHotkeyMode = e.target.value;
            renderSettingsLinks();
            checkDirtyState();
        });

        // Modal Backdrop Click Handling
        let modalMouseDownTarget = null;
        settingsModal.addEventListener('mousedown', (e) => {
            modalMouseDownTarget = e.target;
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal && modalMouseDownTarget === settingsModal) {
                if (checkDirtyState()) {
                    const content = settingsModal.querySelector('.modal-content');
                    content.classList.remove('animate-shake');
                    void content.offsetWidth;
                    content.classList.add('animate-shake');
                    setTimeout(() => content.classList.remove('animate-shake'), 400);
                    return;
                }
                closeSettings();
            }
            modalMouseDownTarget = null;
        });

        let helpModalMouseDownTarget = null;
        helpModal.addEventListener('mousedown', (e) => {
            helpModalMouseDownTarget = e.target;
        });

        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal && helpModalMouseDownTarget === helpModal) {
                closeHelp();
            }
            helpModalMouseDownTarget = null;
        });

        // Handle Back Button / Gesture
        window.addEventListener('popstate', (e) => {
            // If Settings UI is open but state is not settings, close it
            if (settingsModal.classList.contains('modal-active') && (!e.state || e.state.modal !== 'settings')) {
                closeSettingsUI();
            }
            // If Help UI is open but state is not help, close it
            if (helpModal.classList.contains('modal-active') && (!e.state || e.state.modal !== 'help')) {
                closeHelpUI();
            }
        });

        document.addEventListener('keydown', (e) => {
            const activeTag = document.activeElement.tagName;

            // Focus Main Input
            if (e.code === 'Space' && activeTag !== 'INPUT') {
                e.preventDefault();
                mainInput.focus();
            }

            // Escape Actions
            if (e.key === 'Escape') {
                // 1. Close Settings if open
                if (!settingsModal.classList.contains('hidden')) {
                    e.preventDefault();
                    if (checkDirtyState()) {
                        const content = settingsModal.querySelector('.modal-content');
                        content.classList.remove('animate-shake');
                        void content.offsetWidth;
                        content.classList.add('animate-shake');
                        setTimeout(() => content.classList.remove('animate-shake'), 400);
                        return;
                    }
                    closeSettings();
                    return;
                }

                // 2. Close Help if open
                if (!helpModal.classList.contains('hidden')) {
                    e.preventDefault();
                    closeHelp();
                    return;
                }

                // 3. Unfocus Search Input
                if (document.activeElement === mainInput) {
                    e.preventDefault();
                    mainInput.blur();
                }
            }

            // Tab Key Trigger for Search Actions
            if (e.key === 'Tab' && activeTag === 'INPUT' && document.activeElement === mainInput) {
                if (preferences.engineTriggerKey === 'tab' || preferences.engineTriggerKey === 'both') {
                    const val = mainInput.value;
                    const parts = val.trim().split(' ');
                    if (parts.length === 1 && parts[0].length > 0) {
                        const candidate = parts[0];
                        const found = findMatchingEngine(candidate);
                        if (found) {
                            e.preventDefault();
                            activeActionEngine = found;
                            mainInput.value = val + ' ';
                            mainInput.dispatchEvent(new Event('input'));
                        }
                    }
                }
            }

            // Speed Dial Keys (0-9)
            if (activeTag !== 'INPUT') {
                const mode = preferences.linkHotkeyMode;
                if (mode === 'disabled') return;
                const modifierRequired = mode === 'alt';
                const isModifierPressed = e.altKey;
                const matchesModifierConstraint = modifierRequired ? isModifierPressed : !isModifierPressed && !e.metaKey && !e.ctrlKey;
                if (matchesModifierConstraint) {
                    let key = null;
                    if (e.code.startsWith('Digit')) {
                        key = e.code.slice(5);
                    } else if (e.code.startsWith('Numpad')) {
                        key = e.code.slice(6);
                    }
                    if (key !== null) {
                        const index = getLinkIndexFromNumericKey(key);
                        if (index >= 0 && index < preferences.links.length) {
                            e.preventDefault();
                            const url = preferences.links[index].url;
                            if (preferences.openLinkNewTab) {
                                window.open(url, '_blank', 'noopener,noreferrer');
                                clearAndResetInput();
                            } else {
                                window.location.href = url;
                            }
                        }
                    }
                }
            }
        });

        // --- History State Cleanup ---
        if (history.state && (history.state.modal === 'settings' || history.state.modal === 'help')) {
            history.replaceState(null, '', window.location.href);
        }
    </script>
</body>

</html>