<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start Page</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: {
                            light: '#f5f5f5',
                            dark: '#09090b',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Smooth fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0; /* Ensure hidden before animation starts */
        }

        /* Modal Transitions */
        .modal-enter {
            opacity: 0;
            pointer-events: none;
        }
        .modal-enter .modal-content {
            transform: scale(0.95);
        }
        .modal-active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-active .modal-content {
            transform: scale(1);
        }

        /* Scrollbar for settings */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(113, 113, 122, 0.3);
            border-radius: 20px;
        }

        /* Dragging visual cue */
        .dragging {
            opacity: 0.5;
            background-color: rgba(113, 113, 122, 0.1);
            border: 2px dashed rgba(113, 113, 122, 0.3);
        }
    </style>
</head>
<body class="min-h-screen bg-background-light dark:bg-background-dark text-zinc-800 dark:text-zinc-300 selection:bg-zinc-200 dark:selection:bg-zinc-800 flex items-center justify-center p-6 relative overflow-hidden transition-colors duration-300">

    <!-- Help Button (Fixed Bottom Left) -->
    <div class="fixed bottom-6 left-6 z-30 animate-fade-in" style="animation-delay: 300ms;">
        <button id="help-toggle" class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-300 transition-all" aria-label="Help">
            <i data-lucide="help-circle" class="w-4 h-4"></i>
        </button>
    </div>

    <!-- Theme & Settings Buttons (Fixed Bottom Right) -->
    <div class="fixed bottom-6 right-6 z-30 flex gap-2 animate-fade-in" style="animation-delay: 300ms;">
        <button id="theme-toggle" class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-300 transition-all" aria-label="Toggle Theme">
            <!-- Icon injected via JS -->
        </button>
        <button id="settings-toggle" class="p-2 rounded-lg text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-800 hover:text-zinc-800 dark:hover:text-zinc-300 transition-all" aria-label="Settings">
            <i data-lucide="settings" class="w-4 h-4"></i>
        </button>
    </div>

    <div class="w-full max-w-3xl space-y-12 mb-12">
        
        <!-- Header Section -->
        <header class="space-y-2 animate-fade-in">
            <div class="flex items-center gap-3 ml-1 text-zinc-500 font-medium text-sm tracking-wide uppercase">
                <p id="date-display">Loading date...</p>
                <span class="w-1 h-1 rounded-full bg-zinc-300 dark:bg-zinc-700"></span>
                <p id="clock-display">00:00</p>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-zinc-900 dark:text-white tracking-tight transition-colors">
                <span id="greeting-display">Hello</span><span id="username-container" class="hidden">, <span id="username-display">User</span></span>
            </h1>
        </header>

        <!-- Search Area -->
        <form id="search-form" class="w-full z-20 flex gap-3 relative animate-fade-in" style="animation-delay: 100ms;">
            
            <!-- Main Input (Separate Box) -->
            <div class="relative flex-1 group">
                <input
                    id="search-input"
                    type="text"
                    placeholder="Search / Ask anything..."
                    autocomplete="off"
                    class="w-full h-16 bg-white/50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-800 text-zinc-900 dark:text-white text-lg rounded-2xl px-6 pr-24 focus:outline-none focus:ring-2 focus:ring-zinc-300 dark:focus:ring-zinc-700 focus:border-transparent transition-[box-shadow,border-color] duration-300 ease-out shadow-sm dark:shadow-lg placeholder:text-zinc-400 dark:placeholder:text-zinc-600"
                    autofocus
                />
                
                <!-- Right Side Indicator -->
                <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                    <!-- Slash Shortcut -->
                    <kbd id="shortcut-slash" class="hidden sm:inline-flex items-center gap-1 px-2.5 py-1 text-xs font-mono text-zinc-400 dark:text-zinc-500 bg-zinc-100 dark:bg-zinc-800 rounded border border-zinc-200 dark:border-zinc-700/50 transition-colors">
                        /
                    </kbd>
                    <!-- Enter Indicator -->
                    <span id="shortcut-enter" class="hidden items-center gap-1 px-2.5 py-1 text-xs font-medium rounded border transition-all">
                        <!-- Content injected via JS -->
                    </span>
                </div>
            </div>
        </form>

        <!-- Links Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 animate-fade-in" id="links-container" style="animation-delay: 200ms;">
            <!-- Links will be injected here by JavaScript -->
        </div>

    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black/20 dark:bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center modal-enter transition-opacity duration-200">
        <div class="modal-content bg-white dark:bg-zinc-900 w-full max-w-lg p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-2xl transition-transform duration-200 ring-1 ring-zinc-900/5 dark:ring-white/10 flex flex-col max-h-[85vh]">
            
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h2 class="text-xl font-bold text-zinc-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="info" class="w-5 h-5 text-blue-500"></i> Usage Guide
                </h2>
                <button id="close-help" class="text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-6 overflow-y-auto custom-scrollbar px-2">
                
                <!-- Search Shortcuts -->
                <div class="space-y-3">
                    <h3 class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="search" class="w-4 h-4"></i> Smart Search
                    </h3>
                    <div class="bg-zinc-50 dark:bg-zinc-800/50 rounded-lg p-4 border border-zinc-100 dark:border-zinc-800 space-y-3">
                        <div class="flex items-start gap-3">
                            <span class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">g query</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                <strong class="text-zinc-900 dark:text-zinc-200">Engine Shortcuts:</strong> Type a shortcut (e.g., 'g') followed by Space/Tab to switch engines instantly.
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">query ?</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                <strong class="text-zinc-900 dark:text-zinc-200">Ask Mode:</strong> End any query with a <code class="bg-zinc-200 dark:bg-zinc-700 px-1 rounded">?</code> to send it to your default AI engine.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Speed Dial -->
                <div class="space-y-3">
                    <h3 class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="zap" class="w-4 h-4"></i> Speed Dial
                    </h3>
                    <div class="bg-zinc-50 dark:bg-zinc-800/50 rounded-lg p-4 border border-zinc-100 dark:border-zinc-800 space-y-3">
                        <div class="flex items-start gap-3">
                            <span class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">1 - 9</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                <strong class="text-zinc-900 dark:text-zinc-200">Hotkeys:</strong> Press number keys 1 through 9 on your keyboard to instantly open the corresponding top link.
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">yt</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                <strong class="text-zinc-900 dark:text-zinc-200">Keywords:</strong> Type a custom shortcut (e.g., 'yt') in the search box and hit Enter to open that site.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="space-y-3">
                    <h3 class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="keyboard" class="w-4 h-4"></i> Navigation
                    </h3>
                    <div class="bg-zinc-50 dark:bg-zinc-800/50 rounded-lg p-4 border border-zinc-100 dark:border-zinc-800">
                         <div class="flex items-start gap-3">
                            <span class="shrink-0 bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 px-2 py-0.5 rounded text-xs font-mono mt-0.5">/</span>
                            <div class="text-sm text-zinc-600 dark:text-zinc-400">
                                Press slash to instantly focus the search bar from anywhere.
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            
            <div class="mt-6 pt-4 border-t border-zinc-100 dark:border-zinc-800 flex justify-end shrink-0">
                <button id="dismiss-help" class="bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 px-6 py-2 rounded-lg font-medium text-sm hover:opacity-90 transition-opacity">
                    Got it
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/20 dark:bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center modal-enter transition-opacity duration-200">
        <div class="modal-content bg-white dark:bg-zinc-900 w-full max-w-lg p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 shadow-2xl transition-transform duration-200 ring-1 ring-zinc-900/5 dark:ring-white/10 flex flex-col max-h-[85vh]">
            
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h2 class="text-xl font-bold text-zinc-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="sliders-horizontal" class="w-5 h-5 text-zinc-500 dark:text-zinc-400"></i> Settings
                </h2>
                <button id="close-settings" class="text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-8 overflow-y-auto custom-scrollbar px-2">
                
                <!-- General Settings -->
                <div class="space-y-4">
                    <h3 class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider">General</h3>
                    
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Name</label>
                        <input type="text" id="setting-username" placeholder="Enter your name" 
                            class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-4 py-2 text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Time Format</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <button class="format-btn p-2 rounded-lg border border-zinc-200 dark:border-zinc-800 text-sm font-medium transition-all hover:bg-zinc-100 dark:hover:bg-zinc-800" data-type="time" data-value="12">12h</button>
                                <button class="format-btn p-2 rounded-lg border border-zinc-200 dark:border-zinc-800 text-sm font-medium transition-all hover:bg-zinc-100 dark:hover:bg-zinc-800" data-type="time" data-value="24">24h</button>
                            </div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="setting-show-seconds" class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                                <span class="text-xs text-zinc-500 dark:text-zinc-400">Show seconds</span>
                            </label>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Date Format</label>
                            <select id="setting-date-format" class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm font-medium text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all appearance-none cursor-pointer mb-2">
                                <option value="full">Default</option>
                                <option value="long">Long Date</option>
                                <option value="short">Short (1/1)</option>
                                <option value="iso">ISO</option>
                            </select>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="setting-show-weekday" class="rounded bg-zinc-100 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700 text-blue-600 focus:ring-blue-500/50">
                                <span class="text-xs text-zinc-500 dark:text-zinc-400">Show day of week</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Search & Ask Engines Settings -->
                <div class="space-y-4" id="settings-engines-section">
                    <h3 class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider">Search & Ask Engines</h3>
                    
                    <p class="text-xs text-zinc-500 dark:text-zinc-400">
                        Use shortcuts (e.g., type "g cat" for Google). Default <i data-lucide="search" class="inline w-3 h-3"></i>. Ask <i data-lucide="message-circle-question" class="inline w-3 h-3"></i> for "?".
                    </p>

                    <!-- Shortcut Trigger Setting -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Shortcut Trigger Key</label>
                        <select id="setting-shortcut-trigger" class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all appearance-none cursor-pointer">
                            <option value="space">Spacebar (Default)</option>
                            <option value="tab">Tab Key</option>
                            <option value="both">Both (Space or Tab)</option>
                        </select>
                        <p class="text-[10px] text-zinc-400 dark:text-zinc-500">
                            Choose which key activates a shortcut (e.g. typing "g" then pressing Space/Tab).
                        </p>
                    </div>

                    <!-- Add/Edit Engine Form -->
                    <div id="engine-form" class="p-4 rounded-xl bg-zinc-50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-800 space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="engine-name" placeholder="Name" 
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                            <input type="text" id="engine-shortcut" placeholder="Shortcut (e.g. g)" 
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                        </div>
                        <input type="url" id="engine-url" placeholder="Query URL (e.g. google.com/search?q=%s)" 
                            class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                        
                        <div class="flex gap-2">
                             <button id="save-engine-btn" class="flex-1 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                                Add Engine
                            </button>
                             <button id="cancel-engine-edit" class="hidden px-4 bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-300 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                                Cancel
                            </button>
                        </div>
                         <!-- Error message for Engine Form -->
                        <p id="engine-error" class="text-red-500 text-xs hidden pt-1"></p>
                    </div>

                    <!-- Engine List -->
                    <div id="settings-engines-list" class="space-y-2">
                        <!-- Engines injected via JS -->
                    </div>
                </div>

                <!-- Speed Dial Settings -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-sm font-semibold text-zinc-900 dark:text-zinc-200 uppercase tracking-wider">Speed Dial <span id="shortcut-count" class="ml-1 text-xs text-zinc-500 font-normal"></span></h3>
                    </div>

                    <!-- Add New Shortcut Form -->
                    <div id="add-shortcut-form" class="p-4 rounded-xl bg-zinc-50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-800 space-y-3">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <input type="text" id="new-link-name" placeholder="Name (e.g. YouTube)" 
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                             <input type="text" id="new-link-shortcut" placeholder="Shortcut (e.g. yt)" 
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                        </div>
                        <input type="url" id="new-link-url" placeholder="URL (e.g. youtube.com)" 
                                class="w-full bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-zinc-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                        <div class="flex gap-2">
                            <button id="save-link-btn" class="flex-1 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                                Add Shortcut
                            </button>
                             <button id="cancel-link-edit" class="hidden px-4 bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-300 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                                Cancel
                            </button>
                        </div>
                         <!-- Error message for Link Form -->
                        <p id="link-error" class="text-red-500 text-xs hidden pt-1"></p>
                    </div>

                    <!-- List of shortcuts -->
                    <div id="settings-links-list" class="space-y-2">
                        <!-- Items injected via JS -->
                    </div>
                </div>

            </div>

            <!-- Footer with Reset, Import, Export, Done -->
            <div class="mt-6 pt-4 border-t border-zinc-100 dark:border-zinc-800 flex justify-between items-center shrink-0">
                <div class="flex gap-2">
                    <button id="reset-settings-btn" class="p-2 rounded-lg text-zinc-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all" title="Reset to Defaults">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    </button>
                    <div class="h-8 w-px bg-zinc-100 dark:bg-zinc-800 mx-1"></div>
                    <button id="import-settings-btn" class="p-2 rounded-lg text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all" title="Import Settings (JSON)">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                    </button>
                    <button id="export-settings-btn" class="p-2 rounded-lg text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all" title="Export Settings (JSON)">
                        <i data-lucide="download" class="w-4 h-4"></i>
                    </button>
                </div>
                <button id="save-settings" class="bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 px-6 py-2 rounded-lg font-medium text-sm hover:opacity-90 transition-opacity">
                    Done
                </button>
            </div>
        </div>
    </div>
    
    <!-- Hidden File Input for Import -->
    <input type="file" id="import-file-input" accept=".json" class="hidden" />

    <script>
        // --- Configuration & State ---
        const DISPLAY_LIMIT = 9; // Only show first 9 on main screen
        
        const defaultEngines = [
            { name: 'Google', url: 'https://www.google.com/search?q=%s', shortcut: 'g' },
            { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=%s', shortcut: 'ddg' },
            { name: 'Bing', url: 'https://www.bing.com/search?q=%s', shortcut: 'b' },
            { name: 'ChatGPT', url: 'https://chatgpt.com/?q=%s', shortcut: 'ai' },
        ];

        let preferences = {
            theme: localStorage.getItem('theme') || 'auto',
            username: localStorage.getItem('username') || '',
            timeFormat: localStorage.getItem('timeFormat') || '12',
            showSeconds: localStorage.getItem('showSeconds') === 'true',
            dateFormat: localStorage.getItem('dateFormat') || 'full',
            showWeekday: localStorage.getItem('showWeekday') !== 'false',
            links: JSON.parse(localStorage.getItem('links') || '[]'),
            searchEngines: JSON.parse(localStorage.getItem('searchEngines') || JSON.stringify(defaultEngines)),
            defaultSearchEngine: parseInt(localStorage.getItem('defaultSearchEngine') || '0'),
            defaultAskEngine: parseInt(localStorage.getItem('defaultAskEngine') || '0'),
            shortcutTrigger: localStorage.getItem('shortcutTrigger') || 'space', // 'space', 'tab', 'both'
        };
        
        // Backwards compatibility for engines without shortcuts
        preferences.searchEngines = preferences.searchEngines.map(e => ({...e, shortcut: e.shortcut || ''}));
        
        // Backwards compatibility for links without shortcuts
        preferences.links = preferences.links.map(l => ({...l, shortcut: l.shortcut || ''}));

        // Runtime State
        let draggedItem = null;
        let lastMouseDownTarget = null;
        let editingEngineIndex = null;
        let editingLinkIndex = null;
        let resetConfirmTimeout = null;
        
        // This tracks the engine that was explicitly triggered by a valid keystroke sequence
        let activeShortcutEngine = null;

        // --- Elements ---
        const dateDisplay = document.getElementById('date-display');
        const greetingDisplay = document.getElementById('greeting-display');
        const usernameContainer = document.getElementById('username-container');
        const usernameDisplay = document.getElementById('username-display');
        const clockDisplay = document.getElementById('clock-display');
        
        // Search Elements
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const shortcutSlash = document.getElementById('shortcut-slash');
        const shortcutEnter = document.getElementById('shortcut-enter');

        const linksContainer = document.getElementById('links-container');
        const themeToggle = document.getElementById('theme-toggle');
        
        // Modal Elements
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings');
        const saveSettingsBtn = document.getElementById('save-settings');

        // Data Management Elements
        const resetSettingsBtn = document.getElementById('reset-settings-btn');
        const importSettingsBtn = document.getElementById('import-settings-btn');
        const exportSettingsBtn = document.getElementById('export-settings-btn');
        const importFileInput = document.getElementById('import-file-input');

        // Help Modal Elements
        const helpToggle = document.getElementById('help-toggle');
        const helpModal = document.getElementById('help-modal');
        const closeHelpBtn = document.getElementById('close-help');
        const dismissHelpBtn = document.getElementById('dismiss-help');

        const settingUsername = document.getElementById('setting-username');
        const settingDateFormat = document.getElementById('setting-date-format');
        const settingShowSeconds = document.getElementById('setting-show-seconds');
        const settingShowWeekday = document.getElementById('setting-show-weekday');
        const settingShortcutTrigger = document.getElementById('setting-shortcut-trigger');
        const formatBtns = document.querySelectorAll('.format-btn');
        
        // Settings - Search Engines
        const engineNameInput = document.getElementById('engine-name');
        const engineUrlInput = document.getElementById('engine-url');
        const engineShortcutInput = document.getElementById('engine-shortcut');
        const saveEngineBtn = document.getElementById('save-engine-btn');
        const cancelEngineEditBtn = document.getElementById('cancel-engine-edit');
        const settingsEnginesList = document.getElementById('settings-engines-list');
        const engineError = document.getElementById('engine-error');

        // Shortcut Settings Elements
        const newLinkName = document.getElementById('new-link-name');
        const newLinkUrl = document.getElementById('new-link-url');
        const newLinkShortcut = document.getElementById('new-link-shortcut');
        const saveLinkBtn = document.getElementById('save-link-btn');
        const cancelLinkEditBtn = document.getElementById('cancel-link-edit');
        const settingsLinksList = document.getElementById('settings-links-list');
        const shortcutCount = document.getElementById('shortcut-count');
        const linkError = document.getElementById('link-error');
        const addShortcutForm = document.getElementById('add-shortcut-form');

        // --- Helper Functions ---
        
        function getFavicon(url) {
            try {
                // Handle %s case where url might not be a valid URL without replacement
                const cleanUrl = url.replace('%s', '');
                const domain = new URL(cleanUrl).hostname;
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
            } catch (e) {
                return 'https://www.google.com/s2/favicons?domain=google.com&sz=64'; 
            }
        }

        function formatUrl(url) {
            if (!url) return '';
            if (!/^https?:\/\//i.test(url)) {
                return 'https://' + url;
            }
            return url;
        }

        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(element) {
            element.classList.add('hidden');
        }

        // --- Core Functions ---

        function updateTime() {
            const now = new Date();
            
            // Time Format
            const timeOptions = { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: preferences.timeFormat === '12',
            };
            
            if (preferences.showSeconds) {
                timeOptions.second = '2-digit';
            }
            
            clockDisplay.textContent = now.toLocaleTimeString('en-US', timeOptions);

            // Date Format
            let dateText = '';
            const d = now;
            
            switch(preferences.dateFormat) {
                case 'long':
                    dateText = d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                    break;
                case 'short':
                    dateText = d.toLocaleDateString('en-US');
                    break;
                case 'iso':
                    dateText = d.toISOString().split('T')[0];
                    break;
                case 'full':
                default:
                    dateText = d.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
                    break;
            }

            if (preferences.showWeekday) {
                const weekday = d.toLocaleDateString('en-US', { weekday: 'long' });
                dateText = `${weekday}, ${dateText}`;
            }

            dateDisplay.textContent = dateText;

            // Greeting
            const hour = now.getHours();
            let greeting = 'Good evening';
            if (hour < 12) greeting = 'Good morning';
            else if (hour < 18) greeting = 'Good afternoon';
            
            greetingDisplay.textContent = greeting;
        }

        function updateGreetingUI() {
            if (preferences.username && preferences.username.trim() !== '') {
                usernameContainer.classList.remove('hidden');
                usernameDisplay.textContent = preferences.username;
            } else {
                usernameContainer.classList.add('hidden');
            }
        }

        // --- Links/Speed Dial Rendering ---

        function renderLinks() {
            // Only show the first 9 links on the dashboard
            const linksToShow = preferences.links.slice(0, DISPLAY_LIMIT);
            
            if (linksToShow.length === 0) {
                linksContainer.innerHTML = '';
                return;
            }

            let html = linksToShow.map((link, index) => `
                <a href="${link.url}" 
                   class="group flex items-center gap-3 p-3 rounded-xl 
                          bg-white/50 dark:bg-zinc-900/30 
                          border border-zinc-200/50 dark:border-zinc-800/50 
                          hover:bg-white/80 dark:hover:bg-zinc-800/50 
                          hover:border-zinc-300 dark:hover:border-zinc-700 
                          transition-all duration-200 shadow-sm dark:shadow-none relative">
                    <div class="absolute top-2 right-2 text-[10px] text-zinc-300 dark:text-zinc-700 font-mono opacity-0 group-hover:opacity-100 transition-opacity">
                        ${index + 1}
                    </div>
                    <div class="p-2 rounded-lg bg-white dark:bg-zinc-800 shadow-sm shrink-0">
                        <img src="${getFavicon(link.url)}" alt="${link.name}" class="w-4 h-4 rounded-sm opacity-90 group-hover:opacity-100">
                    </div>
                    <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400 group-hover:text-zinc-900 dark:group-hover:text-zinc-200 truncate pr-4">
                        ${link.name}
                    </span>
                </a>
            `).join('');
            
            linksContainer.innerHTML = html;
            lucide.createIcons();
        }

        // --- Settings: Shortcut Management ---

        function renderSettingsLinks() {
            shortcutCount.textContent = `(${preferences.links.length})`;
            
            // Reset disabled state since we have no limit now
            saveLinkBtn.disabled = false;
            if(editingLinkIndex === null) {
                saveLinkBtn.textContent = "Add Shortcut";
            }
            newLinkName.disabled = false;
            newLinkUrl.disabled = false;

            if (preferences.links.length === 0) {
                settingsLinksList.innerHTML = `<p class="text-center text-sm text-zinc-400 py-4 italic">No speed dial links added.</p>`;
                return;
            }

            settingsLinksList.innerHTML = preferences.links.map((link, index) => `
                <div class="flex items-center justify-between p-3 rounded-lg bg-zinc-50 dark:bg-zinc-800/50 border border-zinc-100 dark:border-zinc-800 group"
                     draggable="true"
                     data-index="${index}">
                    
                    <div class="flex items-center gap-3 overflow-hidden pointer-events-none">
                        <img src="${getFavicon(link.url)}" class="w-5 h-5 rounded-sm shrink-0">
                        <div class="flex flex-col overflow-hidden">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-zinc-900 dark:text-zinc-200 truncate">${link.name}</span>
                                ${index < 9 ? `<span class="text-xs text-zinc-500 dark:text-zinc-400 font-mono bg-zinc-100 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 px-1.5 py-0.5 rounded">${index + 1}</span>` : ''}
                                ${link.shortcut ? `<span class="text-xs text-zinc-500 dark:text-zinc-400 font-mono bg-zinc-100 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 px-1.5 py-0.5 rounded">${link.shortcut}</span>` : ''}
                            </div>
                            <span class="text-xs text-zinc-400 truncate">${link.url}</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-1">
                        <div class="drag-handle p-2 text-zinc-300 hover:text-zinc-500 dark:text-zinc-600 dark:hover:text-zinc-400 cursor-grab active:cursor-grabbing transition-colors">
                            <i data-lucide="grip-vertical" class="w-4 h-4"></i>
                        </div>
                        <button onclick="editLink(${index})" class="p-2 text-zinc-300 hover:text-yellow-600 dark:text-zinc-600 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 rounded-md transition-colors">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteLink(${index})" class="p-2 text-zinc-300 hover:text-red-500 dark:text-zinc-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
            attachDragListeners();
        }

        // --- Settings: Engine Management ---

        function renderSettingsEngines() {
            settingsEnginesList.innerHTML = preferences.searchEngines.map((eng, index) => {
                const isSearch = index === preferences.defaultSearchEngine;
                const isAsk = index === preferences.defaultAskEngine;
                
                let borderClass = 'border-zinc-100 dark:border-zinc-800';
                
                // Logic for border colors: Green if BOTH, Purple for Ask, Blue for Search
                if (isSearch && isAsk) {
                    borderClass = 'border-green-200 dark:border-green-900/30';
                } else if (isSearch) {
                    borderClass = 'border-blue-200 dark:border-blue-900/30';
                } else if (isAsk) {
                    borderClass = 'border-purple-200 dark:border-purple-900/30';
                }

                return `
                <div class="flex items-center justify-between p-3 rounded-lg bg-zinc-50 dark:bg-zinc-800/50 border ${borderClass} group">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <img src="${getFavicon(eng.url)}" class="w-5 h-5 rounded-sm shrink-0">
                        <div class="flex flex-col overflow-hidden">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-zinc-900 dark:text-zinc-200 truncate">${eng.name}</span>
                                ${eng.shortcut ? `<span class="text-xs text-zinc-500 dark:text-zinc-400 font-mono bg-zinc-100 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 px-1.5 py-0.5 rounded">${eng.shortcut}</span>` : ''}
                            </div>
                            <span class="text-xs text-zinc-400 truncate">${eng.url}</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-1">
                         <!-- Search Default Toggle -->
                        <button onclick="setDefaultSearch(${index})" class="p-2 rounded-md transition-colors ${isSearch ? 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400' : 'text-zinc-300 hover:text-zinc-500 dark:text-zinc-600 dark:hover:text-zinc-400'}" title="Set as Search Default">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </button>
                        
                        <!-- Ask Default Toggle -->
                        <button onclick="setDefaultAsk(${index})" class="p-2 rounded-md transition-colors ${isAsk ? 'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400' : 'text-zinc-300 hover:text-zinc-500 dark:text-zinc-600 dark:hover:text-zinc-400'}" title="Set as Ask Default">
                            <i data-lucide="message-circle-question" class="w-4 h-4"></i>
                        </button>

                        <div class="w-px h-4 bg-zinc-200 dark:bg-zinc-700 mx-1"></div>
                        
                        <!-- Edit Button (Yellow styling on hover) -->
                        <button onclick="editEngine(${index})" class="p-2 text-zinc-300 hover:text-yellow-600 dark:text-zinc-600 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 rounded-md transition-colors">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>

                        <!-- Delete Button -->
                        ${preferences.searchEngines.length > 1 ? `
                        <button onclick="deleteEngine(${index})" class="p-2 text-zinc-300 hover:text-red-500 dark:text-zinc-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }
        
        window.setDefaultSearch = function(index) {
            preferences.defaultSearchEngine = index;
            // FIXED: Immediately save on change
            localStorage.setItem('defaultSearchEngine', preferences.defaultSearchEngine);
            renderSettingsEngines();
        };

        window.setDefaultAsk = function(index) {
            preferences.defaultAskEngine = index;
            // FIXED: Immediately save on change
            localStorage.setItem('defaultAskEngine', preferences.defaultAskEngine);
            renderSettingsEngines();
        };
        
        window.deleteEngine = function(index) {
            if (preferences.searchEngines.length <= 1) return;
            
            // If editing this one, cancel edit
            if (editingEngineIndex === index) cancelEngineEdit();
            // If editing one after this, shift index
            else if (editingEngineIndex > index) editingEngineIndex--;

            preferences.searchEngines.splice(index, 1);
            
            // Adjust indices if needed
            if (preferences.defaultSearchEngine === index) preferences.defaultSearchEngine = 0;
            else if (preferences.defaultSearchEngine > index) preferences.defaultSearchEngine--;
            
            if (preferences.defaultAskEngine === index) preferences.defaultAskEngine = 0;
            else if (preferences.defaultAskEngine > index) preferences.defaultAskEngine--;

            // FIXED: Immediately save changes
            localStorage.setItem('searchEngines', JSON.stringify(preferences.searchEngines));
            localStorage.setItem('defaultSearchEngine', preferences.defaultSearchEngine);
            localStorage.setItem('defaultAskEngine', preferences.defaultAskEngine);

            renderSettingsEngines();
        };

        window.editEngine = function(index) {
            const engine = preferences.searchEngines[index];
            engineNameInput.value = engine.name;
            engineUrlInput.value = engine.url;
            engineShortcutInput.value = engine.shortcut || '';
            
            editingEngineIndex = index;
            saveEngineBtn.textContent = 'Update Engine';
            cancelEngineEditBtn.classList.remove('hidden');
            hideError(engineError);
            
            // Scroll to form
            document.getElementById('engine-form').scrollIntoView({ behavior: 'smooth' });
        };

        window.cancelEngineEdit = function() {
            engineNameInput.value = '';
            engineUrlInput.value = '';
            engineShortcutInput.value = '';
            editingEngineIndex = null;
            saveEngineBtn.textContent = 'Add Engine';
            cancelEngineEditBtn.classList.add('hidden');
            hideError(engineError);
        };
        
        function saveEngine() {
            const name = engineNameInput.value.trim();
            let url = engineUrlInput.value.trim();
            const shortcut = engineShortcutInput.value.trim();
            
            if(!name || !url) return;
            
            // Format URL first to ensure duplicate check matches the actual saved value
            if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

            hideError(engineError);

            // Duplicate Name Check REMOVED per user request

            // Duplicate Shortcut Check (Check BOTH Engines and Links)
            if (shortcut) {
                // Check Engines
                const duplicateShortcut = preferences.searchEngines.find((e, i) => (editingEngineIndex === null || i !== editingEngineIndex) && e.shortcut === shortcut);
                if (duplicateShortcut) {
                    showError(engineError, `Shortcut '${shortcut}' already taken by engine '${duplicateShortcut.name}'.`);
                    return;
                }
                // Check Links (Cross-check)
                const duplicateLinkShortcut = preferences.links.find(l => l.shortcut === shortcut);
                if (duplicateLinkShortcut) {
                    showError(engineError, `Shortcut '${shortcut}' already taken by speed dial '${duplicateLinkShortcut.name}'.`);
                    return;
                }
            }

            // Duplicate URL Check
            const duplicateUrl = preferences.searchEngines.find((e, i) => (editingEngineIndex === null || i !== editingEngineIndex) && e.url === url);
            if (duplicateUrl) {
                showError(engineError, 'URL already exists in search engines.');
                return;
            }
            
            if (editingEngineIndex !== null) {
                // Update
                preferences.searchEngines[editingEngineIndex] = { name, url, shortcut };
                cancelEngineEdit();
            } else {
                // Add
                preferences.searchEngines.push({ name, url, shortcut });
                engineNameInput.value = '';
                engineUrlInput.value = '';
                engineShortcutInput.value = '';
            }
            
            // FIXED: Immediately save to localStorage
            localStorage.setItem('searchEngines', JSON.stringify(preferences.searchEngines));

            renderSettingsEngines();
        }

        // --- Drag & Drop Logic (Speed Dial) ---

        function attachDragListeners() {
            const items = settingsLinksList.querySelectorAll('div[draggable="true"]');
            settingsLinksList.addEventListener('mousedown', (e) => {
                lastMouseDownTarget = e.target;
            });
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            if (!lastMouseDownTarget || !lastMouseDownTarget.closest('.drag-handle')) {
                e.preventDefault();
                return;
            }
            draggedItem = e.target.closest('[draggable]');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', '');
            requestAnimationFrame(() => {
                draggedItem.classList.add('dragging');
                draggedItem.style.opacity = '0.5';
            });
        }

        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }

        function handleDragEnter(e) {
            e.preventDefault();
            const target = e.target.closest('[draggable]');
            if (target && target !== draggedItem) target.classList.add('bg-zinc-100', 'dark:bg-zinc-800');
        }

        function handleDragLeave(e) {
            const target = e.target.closest('[draggable]');
            if (target && target !== draggedItem) target.classList.remove('bg-zinc-100', 'dark:bg-zinc-800');
        }

        function handleDrop(e) {
            e.stopPropagation();
            const targetItem = e.target.closest('[draggable]');
            
            if (draggedItem) { draggedItem.classList.remove('dragging'); draggedItem.style.opacity = '1'; }
            document.querySelectorAll('.bg-zinc-100, .dark\\:bg-zinc-800').forEach(el => {
                if (el !== draggedItem) el.classList.remove('bg-zinc-100', 'dark:bg-zinc-800');
            });

            if (draggedItem && targetItem && draggedItem !== targetItem) {
                const fromIndex = parseInt(draggedItem.getAttribute('data-index'));
                const toIndex = parseInt(targetItem.getAttribute('data-index'));
                const itemToMove = preferences.links[fromIndex];
                preferences.links.splice(fromIndex, 1);
                preferences.links.splice(toIndex, 0, itemToMove);
                
                // If the moved item was being edited, update index
                if(editingLinkIndex === fromIndex) editingLinkIndex = toIndex;

                // FIXED: Immediately save to localStorage when reordering
                localStorage.setItem('links', JSON.stringify(preferences.links));

                renderSettingsLinks();
                renderLinks();
            }
            return false;
        }

        window.editLink = function(index) {
            const link = preferences.links[index];
            newLinkName.value = link.name;
            newLinkUrl.value = link.url;
            newLinkShortcut.value = link.shortcut || '';
            
            editingLinkIndex = index;
            saveLinkBtn.textContent = "Update Shortcut";
            saveLinkBtn.disabled = false;
            newLinkName.disabled = false;
            newLinkUrl.disabled = false;
            
            cancelLinkEditBtn.classList.remove('hidden');
            hideError(linkError);
            document.getElementById('add-shortcut-form').scrollIntoView({ behavior: 'smooth' });
        }

        window.cancelLinkEdit = function() {
            newLinkName.value = '';
            newLinkUrl.value = '';
            newLinkShortcut.value = '';
            editingLinkIndex = null;
            saveLinkBtn.textContent = "Add Shortcut";
            cancelLinkEditBtn.classList.add('hidden');
            hideError(linkError);
            renderSettingsLinks(); // Refreshes disabled state if needed
        }

        function saveLink() {
            const name = newLinkName.value.trim();
            let url = newLinkUrl.value.trim();
            const shortcut = newLinkShortcut.value.trim();
            
            if (!name || !url) { 
                showError(linkError, 'Please enter a valid Name and URL.');
                return; 
            }
            
            // Format URL first
            url = formatUrl(url);

            hideError(linkError);

             // Duplicate Name Validation REMOVED per user request

            // Duplicate Shortcut Validation (Check BOTH Links and Engines)
            if (shortcut) {
                // Check Links
                const duplicateShortcut = preferences.links.find((l, i) => (editingLinkIndex === null || i !== editingLinkIndex) && l.shortcut === shortcut);
                if (duplicateShortcut) {
                    showError(linkError, `Shortcut '${shortcut}' already taken by '${duplicateShortcut.name}'.`);
                    return;
                }
                // Check Engines (Cross-check)
                const duplicateEngineShortcut = preferences.searchEngines.find(e => e.shortcut === shortcut);
                if (duplicateEngineShortcut) {
                    showError(linkError, `Shortcut '${shortcut}' already taken by engine '${duplicateEngineShortcut.name}'.`);
                    return;
                }
            }

            // Duplicate URL Validation
            const duplicateUrl = preferences.links.find((l, i) => (editingLinkIndex === null || i !== editingLinkIndex) && l.url === url);
            if (duplicateUrl) {
                showError(linkError, 'URL already exists in speed dial.');
                return;
            }

            if (editingLinkIndex !== null) {
                // Update
                preferences.links[editingLinkIndex] = { name, url, shortcut };
                cancelLinkEdit();
            } else {
                // Add (No limit check anymore)
                preferences.links.push({ name, url, shortcut });
                newLinkName.value = '';
                newLinkUrl.value = '';
                newLinkShortcut.value = '';
            }
            
            // FIXED: Immediately save to localStorage
            localStorage.setItem('links', JSON.stringify(preferences.links));
            
            renderSettingsLinks();
            renderLinks();
        }

        window.deleteLink = function(index) {
             // If editing this one, cancel edit
            if (editingLinkIndex === index) cancelLinkEdit();
            // If editing one after this, shift index
            else if (editingLinkIndex > index) editingLinkIndex--;

            preferences.links.splice(index, 1);
            
            // FIXED: Immediately save to localStorage
            localStorage.setItem('links', JSON.stringify(preferences.links));
            
            renderSettingsLinks();
            renderLinks();
        };

        // --- Theme Handling ---
        
        function applyTheme() {
            const isDark = preferences.theme === 'dark' || 
                          (preferences.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            let iconName = 'moon';
            if (preferences.theme === 'light') iconName = 'sun';
            if (preferences.theme === 'auto') iconName = 'monitor';
            themeToggle.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4"></i>`;
            lucide.createIcons();
        }

        function cycleTheme() {
            const modes = ['dark', 'light', 'auto'];
            const nextIndex = (modes.indexOf(preferences.theme) + 1) % modes.length;
            preferences.theme = modes[nextIndex];
            localStorage.setItem('theme', preferences.theme);
            applyTheme();
        }

        // --- Data Management Functions (Reset, Import, Export) ---

        function handleResetSettings() {
            if (resetSettingsBtn.dataset.confirm === 'true') {
                // Second click: Perform Reset
                localStorage.clear();
                window.location.reload();
            } else {
                // First click: Request Confirmation
                resetSettingsBtn.dataset.confirm = 'true';
                resetSettingsBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-red-500"></i>`;
                resetSettingsBtn.classList.add('bg-red-50', 'dark:bg-red-900/20');
                lucide.createIcons();
                
                // Reset to normal after 5 seconds if not confirmed
                resetConfirmTimeout = setTimeout(() => {
                    resetSettingsBtn.dataset.confirm = 'false';
                    resetSettingsBtn.innerHTML = `<i data-lucide="rotate-ccw" class="w-4 h-4"></i>`;
                    resetSettingsBtn.classList.remove('bg-red-50', 'dark:bg-red-900/20');
                    lucide.createIcons();
                }, 5000);
            }
        }

        function handleExportSettings() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(preferences, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "start-page-settings.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function handleImportSettings() {
            importFileInput.click();
        }

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Basic validation: Check if essential keys exist
                    if (imported && typeof imported === 'object') {
                        // Merge strategies could vary, but for "Restore", usually we replace.
                        // However, let's just merge keys to be safe.
                        preferences = { ...preferences, ...imported };
                        
                        // Force update of all UI
                        settingUsername.value = preferences.username;
                        settingDateFormat.value = preferences.dateFormat;
                        settingShowSeconds.checked = preferences.showSeconds;
                        settingShowWeekday.checked = preferences.showWeekday;
                        settingShortcutTrigger.value = preferences.shortcutTrigger || 'space';

                        // Save everything to localStorage
                        saveSettings();
                        
                        // Refresh
                        window.location.reload();
                    } else {
                        alert("Invalid settings file.");
                    }
                } catch(err) {
                    console.error("Error parsing settings file:", err);
                    alert("Error parsing settings file.");
                }
            };
            reader.readAsText(file);
            
            // Clear input so same file can be selected again if needed
            importFileInput.value = '';
        });


        // --- Settings Modal Handling ---

        window.openSettings = function(section) {
            // General
            settingUsername.value = preferences.username;
            settingDateFormat.value = preferences.dateFormat;
            settingShowSeconds.checked = preferences.showSeconds;
            settingShowWeekday.checked = preferences.showWeekday;
            settingShortcutTrigger.value = preferences.shortcutTrigger || 'space';
            
            // Format Buttons Active State
            formatBtns.forEach(btn => {
                const isActive = btn.dataset.value === preferences.timeFormat;
                btn.className = `format-btn p-2 rounded-lg border text-sm font-medium transition-all ${
                    isActive 
                    ? 'bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 border-zinc-900 dark:border-white' 
                    : 'border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-400'
                }`;
            });

            renderSettingsLinks();
            renderSettingsEngines();
            
            // Reset Edit Mode
            cancelEngineEdit();
            cancelLinkEdit();

            settingsModal.classList.remove('hidden');
            setTimeout(() => settingsModal.classList.add('modal-active'), 10);
            
            // Scroll to section if specified
            if(section === 'engines') {
                document.getElementById('settings-engines-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function closeSettings() {
            settingsModal.classList.remove('modal-active');
            setTimeout(() => settingsModal.classList.add('hidden'), 200);
            
            // Reset "Reset Button" state if modal closes
            if (resetConfirmTimeout) clearTimeout(resetConfirmTimeout);
            resetSettingsBtn.dataset.confirm = 'false';
            resetSettingsBtn.innerHTML = `<i data-lucide="rotate-ccw" class="w-4 h-4"></i>`;
            resetSettingsBtn.classList.remove('bg-red-50', 'dark:bg-red-900/20');
            lucide.createIcons();
        }

        function saveSettings() {
            preferences.username = settingUsername.value.trim();
            preferences.dateFormat = settingDateFormat.value;
            preferences.showSeconds = settingShowSeconds.checked;
            preferences.showWeekday = settingShowWeekday.checked;
            preferences.shortcutTrigger = settingShortcutTrigger.value;
            
            // Note: links and engines are modified in memory already, just save to LS
            localStorage.setItem('username', preferences.username);
            localStorage.setItem('dateFormat', preferences.dateFormat);
            localStorage.setItem('timeFormat', preferences.timeFormat);
            localStorage.setItem('showSeconds', preferences.showSeconds);
            localStorage.setItem('showWeekday', preferences.showWeekday);
            localStorage.setItem('links', JSON.stringify(preferences.links));
            localStorage.setItem('searchEngines', JSON.stringify(preferences.searchEngines));
            localStorage.setItem('defaultSearchEngine', preferences.defaultSearchEngine);
            localStorage.setItem('defaultAskEngine', preferences.defaultAskEngine);
            localStorage.setItem('shortcutTrigger', preferences.shortcutTrigger);

            updateGreetingUI();
            updateTime();
            closeSettings();
        }

        // --- Help Modal Handling ---
        function openHelp() {
            helpModal.classList.remove('hidden');
            setTimeout(() => helpModal.classList.add('modal-active'), 10);
        }

        function closeHelp() {
            helpModal.classList.remove('modal-active');
            setTimeout(() => helpModal.classList.add('hidden'), 200);
        }

        // --- Event Listeners ---

        applyTheme();
        renderLinks();
        updateGreetingUI();
        updateTime();
        setInterval(updateTime, 1000);

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (preferences.theme === 'auto') applyTheme();
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            let query = searchInput.value.trim();
            if (query) {
                // 1. Check for Speed Dial Shortcuts first (Exact Match)
                const speedDialLink = preferences.links.find(l => l.shortcut === query);
                if (speedDialLink) {
                    window.location.href = speedDialLink.url;
                    return;
                }

                // 2. Check for Search Engine logic
                let engineIndex;
                let usedShortcut = false;

                // Priority: Active Shortcut Engine (from Tab or validated Space)
                if (activeShortcutEngine && query.startsWith(activeShortcutEngine.shortcut)) {
                    // Re-validate that the query actually matches the pattern "shortcut + space"
                    const parts = query.split(' ');
                    if (parts[0] === activeShortcutEngine.shortcut && parts.length > 1) {
                         const engine = activeShortcutEngine;
                         query = parts.slice(1).join(' '); // Remove shortcut
                         let url = engine.url;
                         if (url.includes('%s')) {
                            url = url.replace('%s', encodeURIComponent(query));
                         } else {
                            url = url + encodeURIComponent(query);
                         }
                         window.location.href = url;
                         return;
                    }
                }

                // Standard Parsing Logic (Fallback or Default Behavior)
                // If we didn't use the activeShortcutEngine, check preference
                
                const parts = query.split(' ');
                if (parts.length > 1 && (preferences.shortcutTrigger === 'space' || preferences.shortcutTrigger === 'both')) {
                    const firstWord = parts[0];
                    const shortcutEngineIndex = preferences.searchEngines.findIndex(e => e.shortcut === firstWord);
                    if (shortcutEngineIndex !== -1) {
                        engineIndex = shortcutEngineIndex;
                        query = parts.slice(1).join(' '); // Remove shortcut from query
                        usedShortcut = true;
                    }
                }

                if (!usedShortcut) {
                    if (query.endsWith('?')) {
                         // Ask Mode
                         engineIndex = preferences.defaultAskEngine;
                    } else {
                         // Search Mode
                         engineIndex = preferences.defaultSearchEngine;
                    }
                }
                
                // Fallback if index invalid
                const engine = preferences.searchEngines[engineIndex] || preferences.searchEngines[0];
                
                let url = engine.url;
                if (url.includes('%s')) {
                    url = url.replace('%s', encodeURIComponent(query));
                } else {
                    // Fallback for legacy URLs without %s
                    url = url + encodeURIComponent(query);
                }
                
                window.location.href = url;
            }
        });
        
        // Input listener for Enter vs Slash vs Shortcut Detection
        searchInput.addEventListener('input', (e) => {
            const val = e.target.value;
            const parts = val.trim().split(' ');
            const potentialShortcut = parts[0];
            
            // --- State Management for Shortcuts ---
            
            // 1. Invalidate active engine if text no longer matches
            if (activeShortcutEngine) {
                if (!val.startsWith(activeShortcutEngine.shortcut + ' ')) {
                    activeShortcutEngine = null;
                }
            }
            
            // 2. Detect Space Trigger
            if (!activeShortcutEngine && (preferences.shortcutTrigger === 'space' || preferences.shortcutTrigger === 'both')) {
                 if (val.endsWith(' ') && parts.length >= 1) {
                     // Check if the word before the space is a shortcut
                     const words = val.split(' '); 
                     if (words.length >= 2 && words[words.length - 1] === '') {
                         const candidate = words[words.length - 2];
                         const found = preferences.searchEngines.find(e => e.shortcut === candidate);
                         if (found) {
                             activeShortcutEngine = found;
                         }
                     }
                 }
            }

            // --- UI Updates ---
            
            if(val.length > 0) {
                shortcutSlash.classList.add('hidden');
                shortcutSlash.classList.remove('sm:inline-flex'); 
                
                shortcutEnter.classList.remove('hidden');
                shortcutEnter.classList.add('flex');
                
                // Base classes
                const baseClasses = ['items-center', 'gap-1', 'px-2.5', 'py-1', 'text-xs', 'font-medium', 'rounded', 'border', 'transition-all', 'flex'];
                
                // Colors
                const searchClasses = ['text-blue-600', 'dark:text-blue-400', 'bg-blue-50', 'dark:bg-blue-900/20', 'border-blue-100', 'dark:border-blue-900/30'];
                const askClasses = ['text-purple-600', 'dark:text-purple-400', 'bg-purple-50', 'dark:bg-purple-900/20', 'border-purple-100', 'dark:border-purple-900/30'];
                const shortcutClasses = ['text-emerald-600', 'dark:text-emerald-400', 'bg-emerald-50', 'dark:bg-emerald-900/20', 'border-emerald-100', 'dark:border-emerald-900/30'];
                const linkClasses = ['text-orange-600', 'dark:text-orange-400', 'bg-orange-50', 'dark:bg-orange-900/20', 'border-orange-100', 'dark:border-orange-900/30'];

                // Determine what to show in the UI
                let engineToShow = null;
                let linkToShow = null;
                
                // Check for Speed Dial Link Shortcut (Exact match)
                if (parts.length === 1) {
                    linkToShow = preferences.links.find(l => l.shortcut === parts[0]);
                }

                // A. Explicitly active engine (via Tab or Space trigger)
                if (activeShortcutEngine) {
                    engineToShow = activeShortcutEngine;
                } 
                // B. Implicit detection (Preview)
                else if (preferences.shortcutTrigger === 'space' || preferences.shortcutTrigger === 'both') {
                     engineToShow = preferences.searchEngines.find(e => e.shortcut === potentialShortcut && parts.length > 1);
                }

                if (linkToShow) {
                     // Link Match takes visual priority if exact match
                     shortcutEnter.className = [...baseClasses, ...linkClasses].join(' ');
                     shortcutEnter.innerHTML = `Open ${linkToShow.name} <span class="font-sans"></span>`;
                } else if (engineToShow) {
                     // Shortcut Match
                     shortcutEnter.className = [...baseClasses, ...shortcutClasses].join(' ');
                     shortcutEnter.innerHTML = `Search ${engineToShow.name} <span class="font-sans"></span>`;
                } else {
                    // Standard Logic
                    const isAsk = val.trim().endsWith('?');
                    if (isAsk) {
                        shortcutEnter.className = [...baseClasses, ...askClasses].join(' ');
                        shortcutEnter.innerHTML = `Ask <span class="font-sans"></span>`;
                    } else {
                        shortcutEnter.className = [...baseClasses, ...searchClasses].join(' ');
                        shortcutEnter.innerHTML = `Search <span class="font-sans"></span>`;
                    }
                }
                
            } else {
                activeShortcutEngine = null;
                shortcutSlash.classList.remove('hidden');
                shortcutSlash.classList.add('sm:inline-flex'); 
                
                shortcutEnter.classList.add('hidden');
                shortcutEnter.classList.remove('flex');
            }
        });

        themeToggle.addEventListener('click', cycleTheme);
        settingsToggle.addEventListener('click', () => openSettings());
        helpToggle.addEventListener('click', openHelp);
        closeSettingsBtn.addEventListener('click', closeSettings);
        saveSettingsBtn.addEventListener('click', saveSettings);
        saveLinkBtn.addEventListener('click', saveLink);
        saveEngineBtn.addEventListener('click', saveEngine);
        cancelEngineEditBtn.addEventListener('click', cancelEngineEdit);
        cancelLinkEditBtn.addEventListener('click', cancelLinkEdit);
        
        // Data listeners
        resetSettingsBtn.addEventListener('click', handleResetSettings);
        importSettingsBtn.addEventListener('click', handleImportSettings);
        exportSettingsBtn.addEventListener('click', handleExportSettings);
        
        closeHelpBtn.addEventListener('click', closeHelp);
        dismissHelpBtn.addEventListener('click', closeHelp);

        // Fix: Prevent modal from closing when selecting text and dragging outside
        let modalMouseDownTarget = null;
        settingsModal.addEventListener('mousedown', (e) => {
            modalMouseDownTarget = e.target;
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal && modalMouseDownTarget === settingsModal) {
                closeSettings();
            }
            modalMouseDownTarget = null;
        });
        
        let helpModalMouseDownTarget = null;
        helpModal.addEventListener('mousedown', (e) => {
            helpModalMouseDownTarget = e.target;
        });

        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal && helpModalMouseDownTarget === helpModal) {
                closeHelp();
            }
            helpModalMouseDownTarget = null;
        });

        formatBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                preferences.timeFormat = e.target.dataset.value;
                openSettings(); 
            });
        });

        document.addEventListener('keydown', (e) => {
            const activeTag = document.activeElement.tagName;
            
            // Search Focus
            if (e.key === '/' && activeTag !== 'INPUT') {
                e.preventDefault();
                searchInput.focus();
            }
            
            // Escape Modal
            if (e.key === 'Escape') {
                 if (!settingsModal.classList.contains('hidden')) closeSettings();
                 if (!helpModal.classList.contains('hidden')) closeHelp();
            }

            // Tab Key Trigger for Search Shortcuts
            if (e.key === 'Tab' && activeTag === 'INPUT' && document.activeElement === searchInput) {
                // Only handle if preference allows Tab
                if (preferences.shortcutTrigger === 'tab' || preferences.shortcutTrigger === 'both') {
                    const val = searchInput.value;
                    const parts = val.trim().split(' ');
                    
                    if (parts.length === 1 && parts[0].length > 0) {
                        const candidate = parts[0];
                        const found = preferences.searchEngines.find(e => e.shortcut === candidate);
                        
                        if (found) {
                            e.preventDefault(); // Stop focus move
                            activeShortcutEngine = found;
                            searchInput.value = val + ' '; // Add space
                            searchInput.dispatchEvent(new Event('input')); // Update UI
                        }
                    }
                }
            }

            // Speed Dial Keys (1-9)
            if (activeTag !== 'INPUT' && !e.metaKey && !e.ctrlKey && !e.altKey) {
                const key = parseInt(e.key);
                if (!isNaN(key) && key >= 1 && key <= 9) {
                    const index = key - 1;
                    if (index < preferences.links.length) {
                        const url = preferences.links[index].url;
                        window.location.href = url;
                    }
                }
            }
        });
    </script>
</body>
</html>